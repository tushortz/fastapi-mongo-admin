<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resell Studio Admin</title>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Theme CSS - will be toggled by darkmode.js -->
    <link rel="stylesheet" href="css/lightmode.css" id="theme-stylesheet">
    <!-- Tailwind CSS CDN -->
    <script>
      // Suppress Tailwind CDN production warning (for development use)
      // Must be set before Tailwind loads
      (function() {
        if (typeof console !== 'undefined') {
          const originalWarn = console.warn;
          const originalError = console.error;
          const originalLog = console.log;

          console.warn = function (...args) {
            const message = args[0];
            if (typeof message === 'string' && (
              message.includes('cdn.tailwindcss.com') ||
              message.includes('should not be used in production')
            )) {
              return; // Suppress the warning
            }
            originalWarn.apply(console, args);
          };

          console.error = function (...args) {
            const message = args[0];
            if (typeof message === 'string' && (
              message.includes('cdn.tailwindcss.com') ||
              message.includes('should not be used in production')
            )) {
              return; // Suppress the error
            }
            originalError.apply(console, args);
          };

          console.log = function (...args) {
            const message = args[0];
            if (typeof message === 'string' && (
              message.includes('cdn.tailwindcss.com') ||
              message.includes('should not be used in production')
            )) {
              return; // Suppress the log
            }
            originalLog.apply(console, args);
          };
        }
      })();
    </script>
    <script src="css/tailwind.css"></script>
    <!-- Chart.js CDN -->
    <script src="js/chart.umd.min.js"></script>
    <!-- Admin JS Modules -->
    <script type="module">
      // Import modules (will be loaded as ES modules if supported, otherwise fallback to inline)
      import { debounce, escapeHtml, titleize, ApiCache, batchApiCalls } from './js/utils.js';
      import { ApiClient } from './js/api.js';
      import { toast } from './js/toast.js';
      import { keyboard } from './js/keyboard.js';
      import { makeColumnsResizable, enhanceTableSorting } from './js/table.js';

      // Import number formatting utilities
      import { formatNumber, formatCurrency, parseFormattedNumber, validateNumber, enhanceNumberInput } from './js/utils.js';

      // Make available globally
      window.debounce = debounce;
      window.escapeHtml = escapeHtml;
      window.titleize = titleize;
      window.ApiCache = ApiCache;
      window.batchApiCalls = batchApiCalls;
      window.ApiClient = ApiClient;
      window.toast = toast;
      window.keyboard = keyboard;
      window.makeColumnsResizable = makeColumnsResizable;
      window.enhanceTableSorting = enhanceTableSorting;
      window.formatNumber = formatNumber;
      window.formatCurrency = formatCurrency;
      window.parseFormattedNumber = parseFormattedNumber;
      window.validateNumber = validateNumber;
      window.enhanceNumberInput = enhanceNumberInput;
    </script>
    <script>
      // Fallback if modules not supported
      if (typeof window.debounce === 'undefined') {
        // Load fallback implementations inline
        console.warn('ES modules not fully supported, using inline fallbacks');
      }
    </script>
    <style>
      /* Set Inter as default font */
      * {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      }

      /* Preserve monospace fonts for code/JSON */
      code, pre, .font-mono, textarea[class*="font-mono"] {
        font-family: 'Courier New', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
      }

      /* Custom styles for animations and specific components */
      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal.active .modal-content {
        animation: modalSlideIn 0.3s ease-out;
      }

      #sidenav {
        width: 280px;
        min-width: 280px;
        max-width: 280px;
        flex-shrink: 0;
        transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease, opacity 0.3s ease, padding 0.3s ease, margin 0.3s ease;
      }

      #sidenav.collapsed {
        width: 0 !important;
        min-width: 0 !important;
        max-width: 0 !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        margin: 0 !important;
        overflow: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
        visibility: hidden !important;
        border: none !important;
      }

        .collection-item.expanded .collection-arrow {
            transform: rotate(90deg);
        }
    </style>
</head>

  <body class="flex h-screen overflow-hidden bg-gray-100 text-gray-800 font-sans">
    <!-- Sidebar Navigation -->
    <nav id="sidenav"
      class="bg-gray-800 text-white flex flex-col overflow-y-auto shadow-lg relative">
      <div class="p-5 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
        <div>
          <h1 class="text-lg text-blue-400 mb-1">üîß Admin Panel</h1>
          <p class="text-xs text-gray-400">MongoDB Collections</p>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="toggleDarkMode()"
            class="bg-transparent border-none text-gray-400 cursor-pointer p-1.5 rounded hover:text-white hover:bg-gray-700 transition-colors text-lg"
            title="Toggle dark mode" id="dark-mode-toggle">
            üåô
          </button>
          <button onclick="toggleSidebar()"
            class="bg-transparent border-none text-gray-400 cursor-pointer p-1 rounded hover:text-white hover:bg-gray-700 transition-colors text-lg"
            title="Collapse sidebar">
            ‚óÄ
          </button>
        </div>
      </div>
      <div id="sidenav-content" class="flex-1 py-2">
        <div class="text-center py-10 text-gray-400">Loading collections...</div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <div class="bg-white px-8 py-5 border-b border-gray-200 shadow-sm flex items-center gap-4">
        <button onclick="toggleSidebar()"
          class="sidebar-toggle-btn bg-gray-100 border border-gray-300 text-gray-700 cursor-pointer px-3 py-2 rounded text-base transition-all hidden items-center justify-center min-w-10 hover:bg-gray-200 hover:text-gray-900"
          title="Show sidebar"
          style="display: none;">
          ‚ò∞
        </button>
        <div class="flex-1">
          <h2 id="page-title" class="text-gray-800 text-2xl mb-1">Select a Collection</h2>
          <p id="page-subtitle" class="text-gray-500 text-sm">Choose a collection from the sidebar to get started</p>
        </div>
        <button onclick="toggleDarkMode()"
          class="bg-gray-100 border border-gray-300 text-gray-700 cursor-pointer px-3 py-2 rounded text-base transition-all items-center justify-center min-w-10 hover:bg-gray-200 hover:text-gray-900"
          title="Toggle dark mode" id="dark-mode-toggle-header">
          üåô
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-8 bg-gray-50">
        <div id="error-message" class="hidden p-4 rounded mb-5 bg-red-100 text-red-800"></div>
        <div id="success-message" class="hidden p-4 rounded mb-5 bg-green-100 text-green-800"></div>

            <!-- Browse View -->
        <div id="browse-view" class="hidden">
          <div class="flex gap-2.5 mb-5 flex-wrap">
            <button onclick="showCreateModal()"
              class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-blue-600 text-white hover:bg-blue-700">+
              Create Document</button>
            <button onclick="refreshDocuments()"
              class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">Refresh</button>
            <button onclick="showFieldSelectionModal()"
              class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-indigo-600 text-white hover:bg-indigo-700">
              ‚öôÔ∏è Select Fields
            </button>

            <!-- Export Dropdown -->
            <div class="relative inline-block">
              <button onclick="toggleExportMenu()" id="export-btn"
                class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-green-600 text-white hover:bg-green-700">
                üì• Export
              </button>
              <div id="export-menu" class="hidden absolute left-0 mt-1 w-48 bg-white rounded-md shadow-lg z-10 border border-gray-200">
                <div class="py-1">
                  <a href="#" onclick="exportCollection('csv'); return false;" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CSV</a>
                  <a href="#" onclick="exportCollection('html'); return false;" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">HTML</a>
                  <a href="#" onclick="exportCollection('json'); return false;" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">JSON</a>
                  <a href="#" onclick="exportCollection('toml'); return false;" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">TOML</a>
                  <a href="#" onclick="exportCollection('xml'); return false;" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">XML</a>
                  <a href="#" onclick="exportCollection('yaml'); return false;" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">YAML</a>
                </div>
              </div>
            </div>

            <!-- Import Button -->
            <label for="import-file" class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-purple-600 text-white hover:bg-purple-700 inline-block">
              üì§ Import
            </label>
            <input type="file" id="import-file" accept=".json,.yaml,.yml,.csv,.toml" class="hidden" onchange="handleImportFile(event)">

            <div class="flex-1 flex gap-2.5 items-center ml-5">
              <input type="text" id="search-input" placeholder="Search documents (text or JSON query)"
                class="flex-1 px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800 placeholder-gray-500"
                onkeypress="handleSearchKeyPress(event)">
              <button onclick="performSearch()"
                class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">Search</button>
              <button onclick="clearSearch()" id="clear-search-btn"
                class="hidden px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">Clear</button>
                </div>
          </div>
          <!-- Filters Section -->
          <div id="filters-section" class="mb-5 bg-white rounded-lg shadow p-4 hidden">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-gray-700">Filters</h3>
              <button onclick="toggleFilters()" id="toggle-filters-btn" class="text-xs text-gray-600 hover:text-gray-800">Hide Filters</button>
            </div>
            <div id="filters-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
              <!-- Filters will be dynamically generated here -->
            </div>
            <div class="mt-4 flex gap-2">
              <button onclick="applyFilters()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors">Apply Filters</button>
              <button onclick="clearFilters()" class="px-4 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors">Clear All</button>
            </div>
          </div>
          <div id="table-container" class="hidden bg-white rounded-lg shadow mb-5">
            <div class="overflow-x-auto">
              <table class="w-full border-collapse min-w-full">
                        <thead id="table-head"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
            </div>
            <div id="pagination" class="flex gap-2.5 items-center justify-center p-5"></div>
                </div>
          <div id="empty-state" class="hidden text-center py-15 px-5 text-gray-500">
            <div class="text-5xl mb-5">üì≠</div>
            <h3 class="text-xl font-semibold mb-2">No documents found</h3>
                    <p>This collection is empty. Create your first document!</p>
                </div>
            </div>

            <!-- Schema View -->
        <div id="schema-view" class="hidden">
          <div id="schema-container" class="bg-white rounded-lg p-5 shadow">
            <div class="text-center py-10 text-gray-400">Loading schema...</div>
                </div>
            </div>

            <!-- Analytics View -->
        <div id="analytics-view" class="hidden">
          <div class="bg-white rounded-lg shadow p-6 mb-5">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Analytics Configuration</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Field to Plot</label>
                <select id="analytics-field-select" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800">
                  <option value="">Select a field...</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Group By (Optional)</label>
                <select id="analytics-group-by-select" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800">
                  <option value="">None</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Aggregation Type</label>
                <select id="analytics-aggregation-select" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800">
                  <option value="avg">Average</option>
                  <option value="count">Count</option>
                  <option value="max">Maximum</option>
                  <option value="min">Minimum</option>
                  <option value="sum">Sum</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Chart Type</label>
                <select id="analytics-chart-type-select" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800">
                  <option value="bar">Bar Chart</option>
                  <option value="doughnut">Doughnut Chart</option>
                  <option value="line">Line Chart</option>
                  <option value="pie">Pie Chart</option>
                </select>
              </div>
            </div>
            <button onclick="loadAnalytics()" class="px-5 py-2.5 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition-colors">
              Generate Chart
            </button>
          </div>
          <div id="analytics-chart-container" class="bg-white rounded-lg shadow p-6 hidden">
            <div class="mb-4">
              <h3 class="text-lg font-semibold text-gray-800" id="analytics-chart-title">Chart</h3>
            </div>
            <div class="relative" style="height: 400px;">
              <canvas id="analytics-chart"></canvas>
            </div>
          </div>
          <div id="analytics-empty-state" class="hidden text-center py-15 px-5 text-gray-500 bg-white rounded-lg shadow">
            <div class="text-5xl mb-5">üìä</div>
            <h3 class="text-xl font-semibold mb-2 text-gray-800">No Analytics Data</h3>
            <p class="text-gray-600">Select a field and click "Generate Chart" to visualize your data</p>
          </div>
        </div>

            <!-- Loading View -->
        <div id="loading-view" class="hidden">
          <div class="text-center py-10 text-gray-500">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
            <div>Loading...</div>
          </div>
        </div>

        <!-- Skeleton Loader -->
        <div id="skeleton-loader" class="hidden bg-white rounded-lg shadow mb-5 p-6">
          <div class="animate-pulse space-y-4">
            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
            <div class="h-4 bg-gray-200 rounded w-4/5"></div>
          </div>
        </div>

        <!-- Detail View -->
        <div id="detail-view" class="hidden">
          <div class="mb-5">
            <button onclick="goBackToList()"
              class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors flex items-center gap-2">
              <span>‚Üê</span> Back to List
            </button>
          </div>
          <div id="detail-content" class="bg-white rounded-lg shadow p-6">
            <div class="text-center py-10 text-gray-400">Loading document...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- View Modal -->
    <div id="view-modal"
      class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50 flex items-center justify-center"
      onclick="if(event.target === this) closeViewModal()">
      <div class="bg-white p-8 rounded-lg max-w-4xl w-11/12 max-h-screen overflow-y-auto"
        onclick="event.stopPropagation()">
        <h2 id="view-modal-title" class="text-2xl font-semibold mb-4 text-gray-800">View Document</h2>
        <div id="view-content" class="max-h-[70vh] overflow-y-auto">
          <div class="text-center py-10 text-gray-400">Loading document...</div>
        </div>
        <div class="flex gap-2.5 justify-end mt-5">
          <button type="button" onclick="goBackInView()" id="back-button"
            class="hidden px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">‚Üê
            Back</button>
          <button type="button" onclick="closeViewModal()"
            class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">Close</button>
          <button type="button" onclick="switchToEditFromView()"
            class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-blue-600 text-white hover:bg-blue-700">Edit</button>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal"
      class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50 flex items-center justify-center"
      onclick="if(event.target === this) closeConfirmModal()">
      <div class="bg-white p-8 rounded-lg max-w-md w-11/12 shadow-xl"
        onclick="event.stopPropagation()">
        <div class="mb-6">
          <h2 id="confirm-modal-title" class="text-2xl font-semibold mb-2 text-gray-800">Confirm Delete</h2>
          <p id="confirm-modal-message" class="text-gray-600">Are you sure you want to delete this document? This action cannot be undone.</p>
        </div>
        <div class="flex gap-3 justify-end">
          <button type="button" onclick="closeConfirmModal()"
            class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">Cancel</button>
          <button type="button" onclick="executeDelete()"
            class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-red-600 text-white hover:bg-red-700">Delete</button>
        </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal"
      class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50 flex items-center justify-center"
      onclick="if(event.target === this) closeMessageModal()">
      <div class="bg-white p-8 rounded-lg max-w-md w-11/12 shadow-xl"
        onclick="event.stopPropagation()">
        <div class="mb-6">
          <div id="message-modal-icon" class="text-4xl mb-4 text-center">‚ÑπÔ∏è</div>
          <h2 id="message-modal-title" class="text-2xl font-semibold mb-2 text-gray-800 text-center">Message</h2>
          <p id="message-modal-message" class="text-gray-600 whitespace-pre-line text-center"></p>
        </div>
        <div class="flex gap-3 justify-center">
          <button type="button" onclick="closeMessageModal()"
            class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-blue-600 text-white hover:bg-blue-700">OK</button>
        </div>
      </div>
    </div>

    <!-- Import Confirmation Modal -->
    <div id="import-confirm-modal"
      class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50 flex items-center justify-center"
      onclick="if(event.target === this) closeImportConfirmModal(null)">
      <div class="bg-white p-8 rounded-lg max-w-md w-11/12 shadow-xl"
        onclick="event.stopPropagation()">
        <div class="mb-6">
          <h2 id="import-confirm-modal-title" class="text-2xl font-semibold mb-2 text-gray-800">Confirm Import</h2>
          <p id="import-confirm-modal-message" class="text-gray-600">Do you want to overwrite existing documents with the same _id?</p>
        </div>
        <div class="flex gap-3 justify-end">
          <button type="button" onclick="closeImportConfirmModal(false)"
            class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">No</button>
          <button type="button" onclick="closeImportConfirmModal(true)"
            class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-blue-600 text-white hover:bg-blue-700">Yes</button>
        </div>
      </div>
    </div>

    <!-- Field Selection Modal -->
    <div id="field-selection-modal"
      class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50 flex items-center justify-center"
      onclick="if(event.target === this) closeFieldSelectionModal()">
      <div class="bg-white p-8 rounded-lg max-w-2xl w-11/12 max-h-[80vh] overflow-y-auto shadow-xl"
        onclick="event.stopPropagation()">
        <div class="mb-6">
          <h2 class="text-2xl font-semibold mb-2 text-gray-800">Select Fields to Display</h2>
          <p class="text-gray-600 text-sm mb-4">Choose which fields to show in the table view. Your selection will be saved.</p>
          <div id="field-selection-container" class="space-y-2">
            <!-- Fields will be populated here -->
          </div>
        </div>
        <div class="flex gap-3 justify-between items-center">
          <div class="flex gap-2">
            <button type="button" onclick="selectAllFields()"
              class="px-4 py-2 border border-gray-300 rounded text-sm cursor-pointer transition-all font-medium bg-white text-gray-700 hover:bg-gray-50">Select All</button>
            <button type="button" onclick="deselectAllFields()"
              class="px-4 py-2 border border-gray-300 rounded text-sm cursor-pointer transition-all font-medium bg-white text-gray-700 hover:bg-gray-50">Deselect All</button>
          </div>
          <div class="flex gap-3">
            <button type="button" onclick="closeFieldSelectionModal()"
              class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">Cancel</button>
            <button type="button" onclick="applyFieldSelection()"
              class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-blue-600 text-white hover:bg-blue-700">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="modal"
      class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50 flex items-center justify-center"
      onclick="if(event.target === this) closeModal()">
      <div class="bg-white p-8 rounded-lg max-w-2xl w-11/12 max-h-screen overflow-y-auto"
        onclick="event.stopPropagation()">
        <h2 id="modal-title" class="text-2xl font-semibold mb-4 text-gray-800">Create Document</h2>
            <form id="document-form" onsubmit="handleSubmit(event)">
                <div id="form-fields"></div>
                <div id="form-pagination" class="hidden mt-5 mb-5 flex items-center justify-between border-t border-gray-200 pt-4">
                  <button type="button" onclick="previousFormPage()" id="form-prev-btn"
                    class="px-4 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚Üê Previous
                  </button>
                  <span id="form-page-info" class="text-sm text-gray-700 font-medium"></span>
                  <button type="button" onclick="nextFormPage()" id="form-next-btn"
                    class="px-4 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Next ‚Üí
                  </button>
                </div>
          <div class="flex gap-2.5 justify-end mt-5">
            <button type="button" onclick="closeModal()"
              class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">Cancel</button>
            <button type="submit"
              class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-blue-600 text-white hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
      // Reactive state management
      class Store {
        constructor(initialValue) {
          this._value = initialValue;
          this._subscribers = new Set();
        }

        get value() {
          return this._value;
        }

        set value(newValue) {
          if (this._value !== newValue) {
            this._value = newValue;
            this._subscribers.forEach(fn => fn(newValue));
          }
        }

        subscribe(fn) {
          this._subscribers.add(fn);
          return () => this._subscribers.delete(fn);
        }
      }

      // Make Store available globally for darkmode.js
      window.Store = Store;

      // Global state stores
      const collections = new Store([]);
      const currentCollection = new Store('');
      const currentView = new Store('');
      const currentSchema = new Store(null);
      const currentPage = new Store(0);
      const currentSearchQuery = new Store(null);
      const sortField = new Store(null);
      const sortOrder = new Store('asc'); // 'asc' or 'desc'
      const currentViewingDocumentId = new Store(null);
      const sidebarCollapsed = new Store(localStorage.getItem('sidebarCollapsed') === 'true');
        const viewHistory = new Store([]);
        const isNavigatingBack = new Store(false);
        let pendingDeleteAction = null; // Store the delete function to execute
      const activeFilters = new Store({}); // Store active filter values
      let allDocuments = []; // Store all loaded documents for client-side filtering
      const formPage = new Store(0); // Current page in form (0-indexed)
      let formFieldPages = []; // Store field HTML for each page

      // Load dark mode JavaScript after Store is defined
      const darkModeScript = document.createElement('script');
      darkModeScript.src = 'js/darkmode.js';
      document.head.appendChild(darkModeScript);

        // Get API_BASE from injected config or use default
        const API_BASE = (window.ADMIN_CONFIG && window.ADMIN_CONFIG.API_BASE) || '/admin';
        const pageSize = 50;

      // Helper functions
      function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
      }

      function titleize(str) {
        if (str === null || str === undefined) return '';
        const s = String(str);
        // Handle snake_case, kebab-case, and space-separated
        return s
          .replace(/[_-]/g, ' ')
          .replace(/\w\S*/g, (txt) => {
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
          })
          .trim();
      }

      function isObjectId(str) {
        if (typeof str !== 'string') return false;
        return /^[0-9a-fA-F]{24}$/.test(str);
      }

      function getEnumColor(enumValue) {
        // Generate a consistent color for an enum value based on the value itself
        // This ensures the same enum value always has the same color across all fields
        const colors = [
          'bg-blue-100 text-blue-800',
          'bg-purple-100 text-purple-800',
          'bg-indigo-100 text-indigo-800',
          'bg-pink-100 text-pink-800',
          'bg-yellow-100 text-yellow-800',
          'bg-teal-100 text-teal-800',
          'bg-orange-100 text-orange-800',
          'bg-cyan-100 text-cyan-800'
        ];

        // Normalize enum value to ensure consistency across all types
        // Handle null/undefined
        if (enumValue === null || enumValue === undefined) {
          enumValue = '';
        }

        // Create a normalized string representation that's consistent across types
        // Normalize to ensure same values get same colors regardless of type/case differences
        let enumStr;
        if (typeof enumValue === 'number') {
          // For numbers, use the exact string representation (preserves precision)
          enumStr = String(enumValue);
        } else if (typeof enumValue === 'boolean') {
          // For booleans, use lowercase string
          enumStr = String(enumValue).toLowerCase();
        } else if (typeof enumValue === 'string') {
          // For strings, normalize to lowercase and trim to ensure consistency
          // This ensures "Active", "active", "ACTIVE", " active " all get the same color
          enumStr = enumValue.trim().toLowerCase();
        } else {
          // For objects/arrays, use JSON.stringify for consistent representation
          try {
            enumStr = JSON.stringify(enumValue);
          } catch (e) {
            enumStr = String(enumValue).toLowerCase();
          }
        }

        // Generate hash from the normalized enum value string
        // Use a more robust hash function
        let hash = 0;
        if (enumStr.length === 0) {
          hash = 0;
        } else {
          for (let i = 0; i < enumStr.length; i++) {
            const char = enumStr.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32-bit integer
          }
        }

        // Use absolute value and modulo to get consistent index
        const colorIndex = Math.abs(hash) % colors.length;
        return colors[colorIndex];
      }

      // Autocomplete functionality
      let autocompleteTimeouts = {};

      async function handleAutocomplete(fieldName, datalistId) {
        const input = document.getElementById(`field-${fieldName}`);
        const datalist = document.getElementById(datalistId);

        if (!input || !datalist) return;

        const query = input.value.trim();

        // Clear existing timeout
        if (autocompleteTimeouts[fieldName]) {
          clearTimeout(autocompleteTimeouts[fieldName]);
        }

        // Clear datalist if query is less than 3 characters
        if (query.length < 3) {
          datalist.innerHTML = '';
          return;
        }

        // Debounce: wait 300ms after user stops typing
        autocompleteTimeouts[fieldName] = setTimeout(async () => {
          try {
            const url = `${API_BASE}/collections/${currentCollection.value}/fields/${fieldName}/autocomplete?query=${encodeURIComponent(query)}&limit=10`;
            const response = await fetch(url);

            if (!response.ok) {
              return; // Silently fail
            }

            const data = await response.json();
            const suggestions = data.suggestions || [];

            // Update datalist with suggestions
            datalist.innerHTML = suggestions.map(suggestion =>
              `<option value="${escapeHtml(suggestion)}">`
            ).join('');
          } catch (error) {
            // Silently fail on error
            console.debug('Autocomplete error:', error);
          }
        }, 300);
      }

        function formatDateTimeInput(field, value, inputType) {
            let formattedValue = '';
            if (value) {
                let dateObj;
                if (value instanceof Date) {
                    dateObj = value;
                } else if (typeof value === 'string') {
                    dateObj = new Date(value);
                } else if (typeof value === 'object' && value.$date) {
                    dateObj = new Date(value.$date);
                } else {
                    dateObj = new Date(value);
                }
                if (!isNaN(dateObj.getTime())) {
                    if (inputType === 'date') {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        formattedValue = `${year}-${month}-${day}`;
                    } else {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        const hours = String(dateObj.getHours()).padStart(2, '0');
                        const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                        formattedValue = `${year}-${month}-${day}T${hours}:${minutes}`;
                    }
                }
        }
        return `<input type="${inputType}" id="field-${field}" value="${formattedValue}" class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm">`;
      }

      // Sidebar management
      function toggleSidebar() {
        const sidenav = document.getElementById('sidenav');
        const toggleBtn = document.querySelector('.sidebar-toggle-btn');

        if (!sidenav) {
          console.error('Sidebar element not found');
          return;
        }

        const isCollapsed = sidenav.classList.contains('collapsed');

        if (isCollapsed) {
          // Expand sidebar
          sidenav.classList.remove('collapsed');
          sidebarCollapsed.value = false;
          localStorage.setItem('sidebarCollapsed', 'false');
          if (toggleBtn) {
            toggleBtn.classList.add('hidden');
            toggleBtn.style.display = 'none';
            toggleBtn.style.visibility = 'hidden';
          }
        } else {
          // Collapse sidebar
          sidenav.classList.add('collapsed');
          sidebarCollapsed.value = true;
          localStorage.setItem('sidebarCollapsed', 'true');
          if (toggleBtn) {
            toggleBtn.classList.remove('hidden');
            toggleBtn.style.display = 'flex';
            toggleBtn.style.visibility = 'visible';
          }
        }

        // Force a reflow to ensure CSS transitions work
        void sidenav.offsetWidth;
      }

      // Initialize sidebar state
      sidebarCollapsed.subscribe(collapsed => {
        const sidenav = document.getElementById('sidenav');
        const toggleBtn = document.querySelector('.sidebar-toggle-btn');
        if (collapsed) {
          sidenav.classList.add('collapsed');
          if (toggleBtn) {
            toggleBtn.classList.remove('hidden');
            toggleBtn.style.display = 'flex';
            toggleBtn.style.visibility = 'visible';
          }
        } else {
          sidenav.classList.remove('collapsed');
          if (toggleBtn) {
            toggleBtn.classList.add('hidden');
            toggleBtn.style.display = 'none';
          }
        }
      });

      // API functions
        async function loadCollections() {
            try {
                const response = await fetch(`${API_BASE}/collections`);
                const data = await response.json();
          collections.value = data.collections;
                renderSidenav();
            } catch (error) {
                showError('Failed to load collections: ' + error.message);
            }
        }

        function renderSidenav() {
            const sidenavContent = document.getElementById('sidenav-content');
            // Ensure collections.value is an array
            if (!collections.value || !Array.isArray(collections.value)) {
                collections.value = [];
            }
            if (collections.value.length === 0) {
                sidenavContent.innerHTML = '<div class="text-center py-10 text-gray-400"><p>No collections found</p></div>';
                return;
            }
            // Sort collections alphabetically
            const sortedCollections = [...collections.value].sort((a, b) =>
                a.toLowerCase().localeCompare(b.toLowerCase())
            );
            sidenavContent.innerHTML = sortedCollections.map(collection => {
                const displayName = titleize(collection);
                return `
                <div class="border-b border-gray-700" data-collection="${collection}">
                    <div class="px-5 py-3 cursor-pointer flex justify-between items-center transition-colors hover:bg-gray-700" onclick="toggleCollection('${collection}')">
                        <span class="font-semibold text-sm">${displayName}</span>
                        <span class="text-xs transition-transform">‚ñ∂</span>
                    </div>
                    <div class="bg-gray-900 hidden py-1 subnav-container">
                        <div class="px-5 py-2 pl-10 cursor-pointer text-sm transition-colors hover:bg-gray-700 flex items-center gap-2 subnav-item" data-view="browse" onclick="navigateTo('${collection}', 'browse')">
                            <span class="w-4 text-center">üìã</span>
                            <span>Browse</span>
                        </div>
                        <div class="px-5 py-2 pl-10 cursor-pointer text-sm transition-colors hover:bg-gray-700 flex items-center gap-2 subnav-item" data-view="create" onclick="navigateTo('${collection}', 'create')">
                            <span class="w-4 text-center">‚ûï</span>
                            <span>Create</span>
                        </div>
                        <div class="px-5 py-2 pl-10 cursor-pointer text-sm transition-colors hover:bg-gray-700 flex items-center gap-2 subnav-item" data-view="schema" onclick="navigateTo('${collection}', 'schema')">
                            <span class="w-4 text-center">üìä</span>
                            <span>Schema</span>
                        </div>
                        <div class="px-5 py-2 pl-10 cursor-pointer text-sm transition-colors hover:bg-gray-700 flex items-center gap-2 subnav-item" data-view="analytics" onclick="navigateTo('${collection}', 'analytics')">
                            <span class="w-4 text-center">üìà</span>
                            <span>Analytics</span>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function toggleCollection(collection) {
            const item = document.querySelector(`[data-collection="${collection}"]`);
        const subnav = item.querySelector('.subnav-container');
        if (subnav) {
            item.classList.toggle('expanded');
          if (item.classList.contains('expanded')) {
            subnav.classList.remove('hidden');
          } else {
            subnav.classList.add('hidden');
          }
            }
        }

        async function loadDocuments() {
            try {
          // Check if collection is set
          if (!currentCollection.value) {
            console.warn('Cannot load documents: no collection selected');
            return;
          }

          // If there's a search query or filters, use the search endpoint
          const hasSearch = currentSearchQuery.value && currentSearchQuery.value.trim();
          const hasFilters = Object.keys(activeFilters.value).length > 0;

          let data;

          if (hasSearch || hasFilters) {
            // Build MongoDB query combining search and filters
            const mongoQuery = {};
            const searchConditions = [];

            // Add search query
            if (hasSearch) {
              const searchQuery = currentSearchQuery.value.trim();
              // Try to parse as JSON first (for advanced MongoDB queries)
              try {
                const parsedQuery = JSON.parse(searchQuery);
                if (typeof parsedQuery === 'object' && parsedQuery !== null && !Array.isArray(parsedQuery)) {
                  // Merge parsed query into mongoQuery (for direct field matches)
                  Object.assign(mongoQuery, parsedQuery);
                } else {
                  // If not an object, treat as text search
                  searchConditions.push({ _id: { $regex: searchQuery, $options: 'i' } });
                  // Add common field searches if schema is available
                  if (currentSchema.value && currentSchema.value.fields) {
                    const stringFields = Object.keys(currentSchema.value.fields).filter(
                      fieldName => {
                        const fieldType = String(currentSchema.value.fields[fieldName].type || '').toLowerCase();
                        return fieldType === 'str' || fieldType === 'string';
                      }
                    );
                    stringFields.forEach(field => {
                      searchConditions.push({ [field]: { $regex: searchQuery, $options: 'i' } });
                    });
                  }
                  if (searchConditions.length > 0) {
                    mongoQuery['$or'] = searchConditions;
                  }
                }
              } catch (e) {
                // Not valid JSON, treat as text search
                searchConditions.push({ _id: { $regex: searchQuery, $options: 'i' } });
                // Add common field searches if schema is available
                if (currentSchema.value && currentSchema.value.fields) {
                  const stringFields = Object.keys(currentSchema.value.fields).filter(
                    fieldName => {
                      const fieldType = String(currentSchema.value.fields[fieldName].type || '').toLowerCase();
                      return fieldType === 'str' || fieldType === 'string';
                    }
                  );
                  stringFields.forEach(field => {
                    searchConditions.push({ [field]: { $regex: searchQuery, $options: 'i' } });
                  });
                }
                if (searchConditions.length > 0) {
                  mongoQuery['$or'] = searchConditions;
                }
              }
            }

            // Add filters to query (these are ANDed with search)
            if (hasFilters) {
              const schema = currentSchema.value;
              Object.entries(activeFilters.value).forEach(([fieldName, filterValue]) => {
                const fieldInfo = schema && schema.fields ? schema.fields[fieldName] : null;
                if (!fieldInfo) {
                  // Default: case-insensitive text search
                  mongoQuery[fieldName] = { $regex: filterValue, $options: 'i' };
                  return;
                }

                const fieldType = String(fieldInfo.type || '').toLowerCase();

                if (fieldInfo.enum && Array.isArray(fieldInfo.enum)) {
                  // Enum: direct match
                  mongoQuery[fieldName] = filterValue;
                } else if (fieldType === 'bool' || fieldType === 'boolean') {
                  // Boolean: convert string to boolean
                  mongoQuery[fieldName] = filterValue === 'true';
                } else if (fieldType === 'datetime' || fieldType === 'date' || fieldType === 'timestamp') {
                  // Date: match date range (start of day to end of day)
                  const startDate = new Date(filterValue);
                  startDate.setHours(0, 0, 0, 0);
                  const endDate = new Date(filterValue);
                  endDate.setHours(23, 59, 59, 999);
                  mongoQuery[fieldName] = {
                    $gte: startDate.toISOString(),
                    $lte: endDate.toISOString()
                  };
                } else if (fieldType === 'str' || fieldType === 'string' || fieldType === 'text') {
                  // Text/string: case-insensitive regex match
                  mongoQuery[fieldName] = { $regex: filterValue, $options: 'i' };
                } else {
                  // Default: exact match
                  mongoQuery[fieldName] = filterValue;
                }
              });
            }

            // Use search endpoint
            const skip = currentPage.value * pageSize;
            let searchUrl = `${API_BASE}/collections/${currentCollection.value}/documents/search?skip=${skip}&limit=${pageSize}`;
            if (sortField.value) {
              searchUrl += `&sort_field=${encodeURIComponent(sortField.value)}&sort_order=${sortOrder.value}`;
            }
            const response = await fetch(
              searchUrl,
              {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(mongoQuery),
              }
            );

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.detail || 'Failed to search documents');
            }

            data = await response.json();
          } else {
            // No search or filters, use normal list endpoint
            let url = `${API_BASE}/collections/${currentCollection.value}/documents?skip=${currentPage.value * pageSize}&limit=${pageSize}`;
            if (sortField.value) {
              url += `&sort_field=${encodeURIComponent(sortField.value)}&sort_order=${sortOrder.value}`;
            }
            const response = await fetch(url);
            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.detail || 'Failed to load documents');
            }
            data = await response.json();
          }

          // Check if data is valid
          if (!data || !data.documents) {
            throw new Error('Invalid response from server');
          }

          // Always refetch schema to ensure filters match current collection
          try {
            const schemaResponse = await fetch(`${API_BASE}/collections/${currentCollection.value}/schema?sample_size=10`);
            if (schemaResponse.ok) {
              const newSchema = await schemaResponse.json();
              // Check if schema has changed (different fields)
              const schemaChanged = !currentSchema.value ||
                !currentSchema.value.fields ||
                JSON.stringify(Object.keys(currentSchema.value.fields || {})) !==
                JSON.stringify(Object.keys(newSchema.fields || {}));

              currentSchema.value = newSchema;

              // Clear filters if schema changed (different collection or schema update)
              if (schemaChanged) {
                activeFilters.value = {};
              }

              // Always regenerate filters based on current schema
              generateFilters();
            }
          } catch (e) {
            // Silently fail schema loading
            console.warn('Failed to load schema for filters:', e);
            // Still try to generate filters with existing schema if available
            if (currentSchema.value && currentSchema.value.fields) {
              generateFilters();
            }
          }

          // Store all documents for client-side filtering
          allDocuments = Array.isArray(data.documents) ? data.documents : [];

          document.getElementById('loading-view').classList.add('hidden');
          document.getElementById('browse-view').classList.remove('hidden');
                if (!allDocuments || allDocuments.length === 0) {
            document.getElementById('table-container').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            if (currentSearchQuery.value) {
              document.querySelector('#empty-state h3').textContent = 'No documents found';
              document.querySelector('#empty-state p').textContent = `No documents match your search query: "${currentSearchQuery.value}"`;
            }
                } else {
            document.getElementById('empty-state').classList.add('hidden');
                    renderTable(data.documents, data.total);
                }
            } catch (error) {
          document.getElementById('loading-view').classList.add('hidden');
                showError('Failed to load documents: ' + error.message);
            }
        }

        function generateFilters() {
          const schema = currentSchema.value;
          if (!schema || !schema.fields) {
            // Hide filters section if no schema
            const filtersSection = document.getElementById('filters-section');
            if (filtersSection) {
              filtersSection.classList.add('hidden');
            }
            return;
          }

          const filtersContainer = document.getElementById('filters-container');
          if (!filtersContainer) return;

          // Find all filterable fields: enums, booleans, and dates only
          // (Text fields are handled by the top search bar, not individual filters)
          const filterableFields = Object.entries(schema.fields).filter(([fieldName, fieldInfo]) => {
            if (!fieldInfo) return false;
            const fieldType = (fieldInfo.type || '').toLowerCase();

            // Check for enum fields
            if (fieldInfo.enum && Array.isArray(fieldInfo.enum) && fieldInfo.enum.length > 0) {
              return true;
            }

            // Check for boolean fields
            if (fieldType === 'bool' || fieldType === 'boolean') {
              return true;
            }

            // Check for date/datetime fields
            if (fieldType === 'datetime' || fieldType === 'date' || fieldType === 'timestamp') {
              return true;
            }

            return false;
          });

          const filtersSection = document.getElementById('filters-section');
          if (!filtersSection) return;

          if (filterableFields.length === 0) {
            filtersSection.classList.add('hidden');
                return;
            }

          // Show filters section and generate filter inputs
          filtersSection.classList.remove('hidden');
          filtersContainer.classList.remove('hidden'); // Ensure container is visible

          filtersContainer.innerHTML = filterableFields.map(([fieldName, fieldInfo]) => {
            if (!fieldInfo) return '';
            const fieldType = fieldInfo.type ? String(fieldInfo.type).toLowerCase() : '';
            let filterInput = '';

            if (fieldInfo.enum && Array.isArray(fieldInfo.enum) && fieldInfo.enum.length > 0) {
              // Enum filter: dropdown with all enum values (sorted)
              const sortedEnum = [...fieldInfo.enum].sort((a, b) => {
                const aStr = String(a);
                const bStr = String(b);
                return aStr.localeCompare(bStr, undefined, { sensitivity: 'base' });
              });
              const options = sortedEnum.map(enumVal => {
                const enumStr = String(enumVal);
                const enumDisplay = titleize(enumStr);
                const selected = activeFilters.value[fieldName] === enumStr ? 'selected' : '';
                return `<option value="${escapeHtml(enumStr)}" ${selected}>${escapeHtml(enumDisplay)}</option>`;
              }).join('');
              filterInput = `
                <select id="filter-${fieldName}" onchange="applyFilters()" class="w-full px-2.5 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800">
                  <option value="">All ${escapeHtml(titleize(fieldName))}</option>
                  ${options}
                </select>
              `;
            } else if (fieldType === 'bool' || fieldType === 'boolean') {
              // Boolean filter: dropdown with True/False options
              const trueSelected = activeFilters.value[fieldName] === 'true' ? 'selected' : '';
              const falseSelected = activeFilters.value[fieldName] === 'false' ? 'selected' : '';
              filterInput = `
                <select id="filter-${fieldName}" onchange="applyFilters()" class="w-full px-2.5 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800">
                  <option value="">All ${escapeHtml(titleize(fieldName))}</option>
                  <option value="true" ${trueSelected}>True</option>
                  <option value="false" ${falseSelected}>False</option>
                </select>
              `;
            } else if (fieldType === 'datetime' || fieldType === 'date' || fieldType === 'timestamp') {
              // Date filter: date input
              const currentValue = activeFilters.value[fieldName] || '';
              filterInput = `
                <input type="date" id="filter-${fieldName}" onchange="applyFilters()" value="${escapeHtml(currentValue)}"
                  class="w-full px-2.5 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800">
              `;
            }

            // Only return filter HTML if filterInput was generated
            if (!filterInput) return '';

            return `
              <div>
                <label for="filter-${fieldName}" class="block text-xs font-medium text-gray-700 mb-1">
                  ${escapeHtml(titleize(fieldName))}
                </label>
                ${filterInput}
                </div>
            `;
          }).join('');
        }

        function toggleFilters() {
          const filtersContainer = document.getElementById('filters-container');
          const toggleBtn = document.getElementById('toggle-filters-btn');

          if (!filtersContainer || !toggleBtn) return;

          if (filtersContainer.classList.contains('hidden')) {
            filtersContainer.classList.remove('hidden');
            toggleBtn.textContent = 'Hide Filters';
          } else {
            filtersContainer.classList.add('hidden');
            toggleBtn.textContent = 'Show Filters';
          }
        }

        async function applyFilters() {
          const schema = currentSchema.value;
          if (!schema || !schema.fields) return;

          if (!currentCollection.value) {
            showError('No collection selected.');
            return;
          }

          // Build filter values from inputs
          const filterValues = {};
          Object.keys(schema.fields).forEach(fieldName => {
            const filterInput = document.getElementById(`filter-${fieldName}`);
            if (filterInput) {
              const value = filterInput.value.trim();
              if (value) {
                filterValues[fieldName] = value;
              }
            }
          });

          activeFilters.value = filterValues;

          // Reset to first page when filters change
          currentPage.value = 0;

          // Use loadDocuments which now handles both search and filters via backend
          await loadDocuments();
        }

        async function clearFilters(reloadDocuments = true) {
          activeFilters.value = {};

          // Clear all filter inputs
          const schema = currentSchema.value;
          if (schema && schema.fields) {
            Object.keys(schema.fields).forEach(fieldName => {
              const filterInput = document.getElementById(`filter-${fieldName}`);
              if (filterInput) {
                filterInput.value = '';
              }
            });
          }

          // Reset sort when clearing filters
          sortField.value = null;
          sortOrder.value = 'asc';

          // Only reload documents if requested and we have a collection set
          if (reloadDocuments && currentCollection.value) {
            // Reset to first page and reload all documents
            currentPage.value = 0;
            await loadDocuments();
          }
          // If reloadDocuments is false (e.g., during navigation), just clear the inputs
        }

        function handleSort(field) {
          if (sortField.value === field) {
            // Toggle sort order if clicking the same field
            sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc';
          } else {
            // Set new sort field and default to ascending
            sortField.value = field;
            sortOrder.value = 'asc';
          }
          // Reset to first page when sorting
          currentPage.value = 0;
          loadDocuments();
        }

        function getSortIndicator(field) {
          if (sortField.value !== field) {
            return '<span class="text-gray-400 ml-1">‚Üï</span>';
          }
          return sortOrder.value === 'asc'
            ? '<span class="text-blue-600 ml-1">‚Üë</span>'
            : '<span class="text-blue-600 ml-1">‚Üì</span>';
        }

        // Field selection state
        const selectedFields = new Store({});

        // Load selected fields from localStorage for a collection
        function loadSelectedFields(collectionName) {
          if (!collectionName) return null;
          try {
            const stored = localStorage.getItem(`selectedFields_${collectionName}`);
            return stored ? JSON.parse(stored) : null;
          } catch (e) {
            return null;
          }
        }

        // Save selected fields to localStorage for a collection
        function saveSelectedFields(collectionName, fields) {
          if (!collectionName) return;
          try {
            localStorage.setItem(`selectedFields_${collectionName}`, JSON.stringify(fields));
          } catch (e) {
            console.error('Failed to save selected fields:', e);
          }
        }

        // Get available fields from documents
        function getAvailableFields(documents) {
          const allKeys = new Set();
          documents.forEach(doc => {
            Object.keys(doc).forEach(key => allKeys.add(key));
          });
          return Array.from(allKeys).sort((a, b) => {
            if (a === '_id') return -1;
            if (b === '_id') return 1;
            return a.localeCompare(b);
          });
        }

        function renderTable(documents, total) {
        document.getElementById('table-container').classList.remove('hidden');
            const allKeys = getAvailableFields(documents);

            // Get selected fields for current collection
            const collectionName = currentCollection.value;
            let fieldsToShow = allKeys;

            if (collectionName) {
              const storedFields = loadSelectedFields(collectionName);
              if (storedFields && Object.keys(storedFields).length > 0) {
                // Filter to only show selected fields (always include _id)
                fieldsToShow = allKeys.filter(key => {
                  return key === '_id' || storedFields[key] === true;
                });

                // If no fields selected, show all (fallback)
                if (fieldsToShow.length === 1 && fieldsToShow[0] === '_id') {
                  fieldsToShow = allKeys;
                }
              }
            }

        const keys = fieldsToShow;
            const thead = document.getElementById('table-head');
        thead.innerHTML = '<tr class="bg-gray-50">' +
          keys.map(key => {
            const isActive = sortField.value === key;
            const sortClass = isActive ? 'bg-blue-50' : '';
            const cursorClass = 'cursor-pointer hover:bg-gray-100';
            return `<th onclick="handleSort('${key}')" class="px-3 py-3 text-left border-b border-gray-200 font-semibold text-gray-700 whitespace-nowrap ${sortClass} ${cursorClass} select-none">
              ${escapeHtml(titleize(key))}${getSortIndicator(key)}
            </th>`;
          }).join('') +
          '<th class="px-3 py-3 text-left border-b border-gray-200 font-semibold text-gray-700 whitespace-nowrap">Actions</th>' +
                '</tr>';
            const tbody = document.getElementById('table-body');
            // Get schema to check for enum fields
            const schema = currentSchema.value;
            const fieldSchemas = schema && schema.fields ? schema.fields : {};

            tbody.innerHTML = documents.map(doc => {
                const cells = keys.map(key => {
                    const value = doc[key];
                    let display = value;
                    const fieldInfo = fieldSchemas[key];
                    const isEnum = fieldInfo && fieldInfo.enum && Array.isArray(fieldInfo.enum);

            if (key === '_id' && value) {
              display = `<a href="#" onclick="showDetailPage('${value}'); return false;" class="text-blue-600 underline cursor-pointer font-medium font-mono hover:text-blue-800 transition-colors whitespace-nowrap" title="Click to view document details">${value}</a>`;
            } else if (value === null || value === undefined) {
              display = '<em class="text-gray-400">null</em>';
                    } else if (typeof value === 'boolean') {
                        // Boolean: green for true, red for false
                        const colorClass = value ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const text = value ? 'True' : 'False';
                        display = `<span class="px-2 py-1 rounded text-xs font-semibold ${colorClass} whitespace-nowrap">${text}</span>`;
                    } else if (isEnum) {
                        // Enum: render as colored label/badge
                        // Pass the original value to getEnumColor for consistent hashing
                        const colorClass = getEnumColor(value);
                        const enumValue = String(value);
                        const enumDisplay = titleize(enumValue);
                        display = `<span class="px-2 py-1 rounded text-xs font-semibold ${colorClass} whitespace-nowrap">${escapeHtml(enumDisplay)}</span>`;
                    } else if (typeof value === 'object') {
                        const jsonStr = JSON.stringify(value, null, 2);
              display = `<span class="font-mono text-xs whitespace-nowrap" title="${jsonStr.replace(/"/g, '&quot;')}">${jsonStr.substring(0, 50)}${jsonStr.length > 50 ? '...' : ''}</span>`;
                    } else if (typeof value === 'string' && value.length > 50) {
                        display = `<span class="whitespace-nowrap" title="${escapeHtml(value)}">${value.substring(0, 50)}...</span>`;
                    } else {
                        display = `<span class="whitespace-nowrap">${escapeHtml(String(display))}</span>`;
                    }
            return `<td class="px-3 py-3 text-left border-b border-gray-200 hover:bg-gray-50">${display}</td>`;
                }).join('');
          return `<tr class="hover:bg-gray-50">
                    ${cells}
                    <td class="px-3 py-3 text-left border-b border-gray-200 whitespace-nowrap">
                        <div class="flex gap-1">
                            <button onclick="viewDocument('${doc._id}')" class="px-3 py-1.5 border-none rounded text-xs cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">View</button>
                            <button onclick="editDocument('${doc._id}')" class="px-3 py-1.5 border-none rounded text-xs cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700">Edit</button>
                            <button onclick="deleteDocument('${doc._id}')" class="px-3 py-1.5 border-none rounded text-xs cursor-pointer transition-all font-medium bg-red-600 text-white hover:bg-red-700">Delete</button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            const totalPages = Math.ceil(total / pageSize);
            const pagination = document.getElementById('pagination');
        const searchInfo = currentSearchQuery.value ? `<span class="text-gray-500 text-xs mr-2.5">Search: "${currentSearchQuery.value}"</span>` : '';
            pagination.innerHTML = `
                ${searchInfo}
                <button onclick="changePage(${currentPage.value - 1})" class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700 ${currentPage.value === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage.value === 0 ? 'disabled' : ''}>Previous</button>
                <span class="px-2">Page ${currentPage.value + 1} of ${totalPages} (${total} total)</span>
                <button onclick="changePage(${currentPage.value + 1})" class="px-5 py-2.5 border-none rounded text-sm cursor-pointer transition-all font-medium bg-gray-600 text-white hover:bg-gray-700 ${currentPage.value >= totalPages - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage.value >= totalPages - 1 ? 'disabled' : ''}>Next</button>
            `;
        }

        async function changePage(page) {
            if (page < 0) return;
            currentPage.value = page;

            // If filters are active, use applyFilters instead of loadDocuments
            if (Object.keys(activeFilters.value).length > 0) {
              await applyFilters();
            } else {
              await loadDocuments();
            }
        }

      async function showDetailPage(documentId) {
        try {
          // Hide all views
          document.querySelectorAll('[id$="-view"]').forEach(v => v.classList.add('hidden'));
          // Show detail view
          document.getElementById('detail-view').classList.remove('hidden');

          const detailContent = document.getElementById('detail-content');
          detailContent.innerHTML = '<div class="text-center py-10 text-gray-400">Loading document...</div>';

          // Update page title
          document.getElementById('page-title').textContent = `Document Details - ${titleize(currentCollection.value)}`;
          document.getElementById('page-subtitle').textContent = `Viewing document: ${documentId}`;

          // Refetch schema and regenerate filters in background
          // This ensures filters are up to date when going back to list
          try {
            const schemaResponse = await fetch(`${API_BASE}/collections/${currentCollection.value}/schema?sample_size=10`);
            if (schemaResponse.ok) {
              currentSchema.value = await schemaResponse.json();
              // Generate filter UI after schema is loaded
              generateFilters();
            }
          } catch (e) {
            // Silently fail schema loading - not critical for detail view
            console.warn('Failed to refresh schema:', e);
          }

          // Fetch document
          const response = await fetch(`${API_BASE}/collections/${currentCollection.value}/documents/${documentId}`);
          if (!response.ok) {
            throw new Error('Document not found');
          }
          const doc = await response.json();

          // Render document details
          renderDetailPage(doc);
        } catch (error) {
          const detailContent = document.getElementById('detail-content');
          detailContent.innerHTML = `
                    <div class="p-4 rounded mb-5 bg-red-100 text-red-800">
                        <p class="font-semibold mb-2">Error loading document</p>
                        <p>${error.message}</p>
                        <button onclick="goBackToList()" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Back to List</button>
                    </div>
                `;
        }
      }

      function renderDetailPage(doc) {
        const detailContent = document.getElementById('detail-content');
        const fields = Object.keys(doc).sort();

        // Get schema to check for enum fields
        const schema = currentSchema.value;
        const fieldSchemas = schema && schema.fields ? schema.fields : {};

        detailContent.innerHTML = `
                <div class="mb-6 pb-4 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Document Details</h2>
                    <p class="text-gray-600 text-sm">Collection: <span class="font-semibold">${titleize(currentCollection.value)}</span></p>
                    <p class="text-gray-600 text-sm">Document ID: <span class="font-mono font-semibold">${doc._id}</span></p>
                </div>
                <div class="space-y-4">
                    ${fields.map(field => {
          const value = doc[field];
          let displayValue = '';
          let fieldType = '';
          const fieldInfo = fieldSchemas[field];
          const isEnum = fieldInfo && fieldInfo.enum && Array.isArray(fieldInfo.enum);

          // Use schema type if available, otherwise infer from value
          const schemaType = fieldInfo && fieldInfo.type ? String(fieldInfo.type).toLowerCase() : null;

          if (value === null || value === undefined) {
            displayValue = '<span class="text-gray-400 italic">null</span>';
            fieldType = schemaType || 'null';
          } else if (typeof value === 'object') {
            if (Array.isArray(value)) {
              const hasObjectIds = value.some(item => typeof item === 'string' && isObjectId(item));
              if (hasObjectIds) {
                const formattedArray = value.map(item => {
                  if (typeof item === 'string' && isObjectId(item)) {
                    return `<a href="#" onclick="showDetailPage('${item}'); return false;" class="text-blue-600 underline cursor-pointer font-medium hover:text-blue-800 transition-colors" title="Click to view this document">"${item}"</a>`;
                  }
                  return JSON.stringify(item);
                });
                displayValue = `[${formattedArray.join(', ')}]`;
                fieldType = `array (${value.length} items, contains ObjectIds)`;
              } else {
                displayValue = `<pre class="bg-gray-50 p-3 rounded overflow-x-auto text-xs m-0"><code class="font-mono text-gray-800">${JSON.stringify(value, null, 2)}</code></pre>`;
                fieldType = `array (${value.length} items)`;
              }
            } else {
              const objectIdFields = Object.entries(value).filter(([k, v]) => typeof v === 'string' && isObjectId(v));
              if (objectIdFields.length > 0) {
                const formattedObj = JSON.parse(JSON.stringify(value));
                objectIdFields.forEach(([k, v]) => {
                  formattedObj[k] = `__OBJECTID_LINK_${v}__`;
                });
                let jsonStr = JSON.stringify(formattedObj, null, 2);
                objectIdFields.forEach(([k, v]) => {
                  const placeholder = `"__OBJECTID_LINK_${v}__"`;
                  const link = `<a href="#" onclick="showDetailPage('${v}'); return false;" class="text-blue-600 underline cursor-pointer font-medium hover:text-blue-800 transition-colors" title="Click to view this document">"${v}"</a>`;
                  jsonStr = jsonStr.replace(placeholder, link);
                });
                displayValue = `<pre class="bg-gray-50 p-3 rounded overflow-x-auto text-xs m-0"><code class="font-mono text-gray-800">${jsonStr}</code></pre>`;
                fieldType = 'object (contains ObjectIds)';
              } else {
                displayValue = `<pre class="bg-gray-50 p-3 rounded overflow-x-auto text-xs m-0"><code class="font-mono text-gray-800">${JSON.stringify(value, null, 2)}</code></pre>`;
                fieldType = 'object';
              }
            }
          } else if (typeof value === 'boolean') {
            // Boolean: green for true, red for false
            const colorClass = value ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const text = value ? 'True' : 'False';
            displayValue = `<span class="px-3 py-1.5 rounded text-sm font-semibold ${colorClass}">${text}</span>`;
            fieldType = 'boolean';
          } else if (isEnum) {
            // Enum: render as colored label/badge
            // Pass the original value to getEnumColor for consistent hashing
            const colorClass = getEnumColor(value);
            const enumValue = String(value);
            const enumDisplay = titleize(enumValue);
            displayValue = `<span class="px-3 py-1.5 rounded text-sm font-semibold ${colorClass}">${escapeHtml(enumDisplay)}</span>`;
            fieldType = schemaType || 'enum';
          } else if (typeof value === 'number') {
            displayValue = `<strong class="text-gray-800">${value}</strong>`;
            if (schemaType) {
              fieldType = schemaType;
            } else {
              fieldType = Number.isInteger(value) ? 'integer' : 'number';
            }
          } else if (typeof value === 'string') {
            if (isObjectId(value)) {
              displayValue = `<a href="#" onclick="showDetailPage('${value}'); return false;" class="text-blue-600 underline cursor-pointer font-medium hover:text-blue-800 transition-colors" title="Click to view this document">${value}</a>`;
              fieldType = schemaType || 'ObjectId';
            } else {
              // Check if schema indicates date/datetime type
              if (schemaType && (schemaType === 'datetime' || schemaType === 'date' || schemaType === 'timestamp')) {
                try {
                  const date = new Date(value);
                  if (!isNaN(date.getTime())) {
                    displayValue = `${value}<br><small class="text-gray-500">${date.toLocaleString()}</small>`;
                    fieldType = schemaType;
                  } else {
                    displayValue = value;
                    fieldType = schemaType || 'string';
                  }
                } catch (e) {
                  displayValue = value;
                  fieldType = schemaType || 'string';
                }
              } else {
                const dateMatch = value.match(/^\d{4}-\d{2}-\d{2}/);
                if (dateMatch) {
                  try {
                    const date = new Date(value);
                    if (!isNaN(date.getTime())) {
                      displayValue = `${value}<br><small class="text-gray-500">${date.toLocaleString()}</small>`;
                      fieldType = 'datetime';
                    } else {
                      displayValue = value;
                      fieldType = schemaType || 'string';
                    }
                  } catch (e) {
                    displayValue = value;
                    fieldType = schemaType || 'string';
                  }
                } else {
                  displayValue = value;
                  fieldType = schemaType || 'string';
                }
              }
            }
          } else {
            displayValue = String(value);
            fieldType = schemaType || typeof value;
          }

          return `
                            <div class="p-4 border-b border-gray-200 last:border-b-0 bg-gray-50 rounded">
                                <div class="font-semibold text-gray-700 mb-2 text-sm uppercase tracking-wide flex items-center gap-2">
                                    <span>${field}</span>
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-normal normal-case tracking-normal">${fieldType}</span>
                                </div>
                                <div class="text-gray-800 text-base break-words mt-2">${displayValue}</div>
                            </div>
                        `;
        }).join('')}
                </div>
                <div class="mt-6 pt-4 border-t border-gray-200 flex gap-3">
                    <button onclick="viewDocument('${doc._id}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">View in Modal</button>
                    <button onclick="editDocument('${doc._id}')" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors">Edit</button>
                    <button onclick="deleteDocumentFromDetail('${doc._id}')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">Delete</button>
                </div>
            `;
      }

      async function goBackToList() {
        document.getElementById('detail-view').classList.add('hidden');
        document.getElementById('browse-view').classList.remove('hidden');
        document.getElementById('page-title').textContent = `${titleize(currentCollection.value)} - Browse`;
        document.getElementById('page-subtitle').textContent = `Managing ${titleize(currentCollection.value)} collection`;

        // Refetch schema to ensure filters are up to date
        try {
          const schemaResponse = await fetch(`${API_BASE}/collections/${currentCollection.value}/schema?sample_size=10`);
          if (schemaResponse.ok) {
            currentSchema.value = await schemaResponse.json();
          }
        } catch (e) {
          console.warn('Failed to refresh schema:', e);
        }

        // Generate filters (this will restore filter values from activeFilters)
        if (currentSchema.value && currentSchema.value.fields) {
          generateFilters();

          // Restore filter input values from activeFilters
          Object.entries(activeFilters.value).forEach(([fieldName, value]) => {
            const filterInput = document.getElementById(`filter-${fieldName}`);
            if (filterInput) {
              filterInput.value = value;
            }
          });
        }

        // Load documents
        await loadDocuments();

        // Apply any active filters after documents are loaded
        if (Object.keys(activeFilters.value).length > 0) {
          // Use setTimeout to ensure documents are rendered first
          setTimeout(() => {
            applyFilters();
          }, 100);
        }
      }

      function deleteDocumentFromDetail(id) {
        showDeleteConfirm(id, true);
      }

      function navigateTo(collection, view) {
        currentSearchQuery.value = null;
        document.getElementById('search-input').value = '';
        document.getElementById('clear-search-btn').classList.add('hidden');
        currentPage.value = 0;

        // Clear filters and schema when switching collections
        const collectionChanged = currentCollection.value !== collection;
        if (collectionChanged) {
          activeFilters.value = {};
          currentSchema.value = null; // Reset schema to force reload
        }

        // Set collection first before clearing filters
        currentCollection.value = collection;
        currentView.value = view;

        // Reset sort when changing collection
        sortField.value = null;
        sortOrder.value = 'asc';

        // Clear filter inputs when navigating (don't reload documents - navigation will handle it)
        clearFilters(false);
        // Remove active states from all collection headers
        document.querySelectorAll('[data-collection] > div:first-child').forEach(h => {
          h.classList.remove('bg-blue-600');
        });
        // Remove active states from all subnav items
        document.querySelectorAll('.subnav-item').forEach(i => {
          i.classList.remove('bg-blue-600', 'text-white');
        });
        const collectionItem = document.querySelector(`[data-collection="${collection}"]`);
        if (collectionItem) {
          if (!collectionItem.classList.contains('expanded')) {
            collectionItem.classList.add('expanded');
            const subnav = collectionItem.querySelector('.subnav-container');
            if (subnav) subnav.classList.remove('hidden');
          }
          // Add active state to collection header
          const header = collectionItem.querySelector('div:first-child');
          if (header) header.classList.add('bg-blue-600');
          // Add active state to selected subnav item
          const subnavItem = collectionItem.querySelector(`.subnav-item[data-view="${view}"]`);
          if (subnavItem) {
            subnavItem.classList.add('bg-blue-600', 'text-white');
          }
        }
        document.getElementById('page-title').textContent = `${titleize(collection)} - ${view.charAt(0).toUpperCase() + view.slice(1)}`;
        document.getElementById('page-subtitle').textContent = `Managing ${titleize(collection)} collection`;
        document.querySelectorAll('[id$="-view"]').forEach(v => v.classList.add('hidden'));
        document.getElementById('loading-view').classList.remove('hidden');
        if (view === 'browse') {
          loadDocuments();
        } else if (view === 'create') {
          loadSchemaForCreate();
        } else if (view === 'schema') {
          loadSchema();
        } else if (view === 'analytics') {
          loadAnalyticsView();
        }
        }

        async function refreshDocuments() {
        currentPage.value = 0;
            await loadDocuments();
        }

      // Debounced search function
      const debouncedPerformSearch = window.debounce ? window.debounce(async () => {
        const searchInput = document.getElementById('search-input');
        const query = searchInput.value.trim();
        if (query) {
          currentSearchQuery.value = query;
          currentPage.value = 0;
          document.getElementById('clear-search-btn').classList.remove('hidden');
          // loadDocuments now uses backend search endpoint
          await loadDocuments();
        } else {
          clearSearch();
        }
      }, 300) : async function() {
        // Fallback if debounce not available
        const searchInput = document.getElementById('search-input');
        const query = searchInput.value.trim();
        if (query) {
          currentSearchQuery.value = query;
          currentPage.value = 0;
          document.getElementById('clear-search-btn').classList.remove('hidden');
          await loadDocuments();
        } else {
          clearSearch();
        }
      };

      async function performSearch() {
        await debouncedPerformSearch();
      }

      async function clearSearch() {
        currentSearchQuery.value = null;
        document.getElementById('search-input').value = '';
        document.getElementById('clear-search-btn').classList.add('hidden');
        currentPage.value = 0;
        // loadDocuments now uses backend - will handle no search/filters case
        await loadDocuments();
      }

      function handleSearchKeyPress(event) {
        if (event.key === 'Enter') {
          performSearch();
        }
        }

      async function showCreateModal() {
        if (!currentCollection.value) {
                showError('Please select a collection first');
                return;
            }
        // Always load schema to ensure it's up to date
        try {
          document.getElementById('loading-view').classList.remove('hidden');
          const response = await fetch(`${API_BASE}/collections/${currentCollection.value}/schema?sample_size=10`);
          if (!response.ok) {
            throw new Error(`Failed to load schema: ${response.statusText}`);
          }
          currentSchema.value = await response.json();
          document.getElementById('loading-view').classList.add('hidden');
        } catch (error) {
          document.getElementById('loading-view').classList.add('hidden');
          showError('Failed to load schema: ' + error.message);
          // Set empty schema so renderForm can handle it
          currentSchema.value = { fields: {}, sample_count: 0 };
        }
        document.getElementById('modal-title').textContent = `Create Document - ${currentCollection.value}`;
            document.getElementById('document-form').dataset.mode = 'create';
            document.getElementById('document-form').dataset.id = '';
            renderForm({});
        document.getElementById('modal').classList.remove('hidden');
      }

      async function viewDocument(id, collection = null) {
        try {
          const targetCollection = collection || currentCollection.value;
          if (!isNavigatingBack.value && currentViewingDocumentId.value && currentViewingDocumentId.value !== id) {
            viewHistory.value = [...viewHistory.value, { id: currentViewingDocumentId.value, collection: currentCollection.value }];
          }
          isNavigatingBack.value = false;
          const backButton = document.getElementById('back-button');
          if (viewHistory.value.length > 0) {
            backButton.classList.remove('hidden');
          } else {
            backButton.classList.add('hidden');
          }
          currentViewingDocumentId.value = id;
          const viewContent = document.getElementById('view-content');
          viewContent.innerHTML = '<div class="text-center py-10 text-gray-400">Loading document...</div>';
          document.getElementById('view-modal-title').textContent = `View Document - ${targetCollection}`;
          document.getElementById('view-modal').classList.remove('hidden');
          const response = await fetch(`${API_BASE}/collections/${targetCollection}/documents/${id}`);
                const doc = await response.json();
          renderViewDocument(doc);
        } catch (error) {
          document.getElementById('view-content').innerHTML = `<div class="p-4 rounded mb-5 bg-red-100 text-red-800">Failed to load document: ${error.message}</div>`;
        }
      }

      async function viewDocumentById(objectId, fieldName = '') {
        try {
          await viewDocument(objectId, currentCollection.value);
        } catch (error) {
          showError(`Document not found in ${currentCollection.value}. Searching other collections...`);
          let found = false;
          for (const collection of collections.value) {
            try {
              const response = await fetch(`${API_BASE}/collections/${collection}/documents/${objectId}`);
              if (response.ok) {
                currentCollection.value = collection;
                await viewDocument(objectId, collection);
                found = true;
                showSuccess(`Document found in ${collection} collection`);
                break;
              }
            } catch (e) { }
          }
          if (!found) {
            showError(`Document with ID ${objectId} not found in any collection`);
          }
        }
      }

      function renderViewDocument(doc) {
        const viewContent = document.getElementById('view-content');
        const fields = Object.keys(doc).sort();

        // Get schema to check for enum fields
        const schema = currentSchema.value;
        const fieldSchemas = schema && schema.fields ? schema.fields : {};

        viewContent.innerHTML = fields.map(field => {
          const value = doc[field];
          let displayValue = '';
          let fieldType = '';
          const fieldInfo = fieldSchemas[field];
          const isEnum = fieldInfo && fieldInfo.enum && Array.isArray(fieldInfo.enum);

          // Use schema type if available, otherwise infer from value
          const schemaType = fieldInfo && fieldInfo.type ? String(fieldInfo.type).toLowerCase() : null;

          if (value === null || value === undefined) {
            displayValue = '<span class="text-gray-400 italic">null</span>';
            fieldType = schemaType || 'null';
          } else if (typeof value === 'object') {
            if (Array.isArray(value)) {
              const hasObjectIds = value.some(item => typeof item === 'string' && isObjectId(item));
              if (hasObjectIds) {
                const formattedArray = value.map(item => {
                  if (typeof item === 'string' && isObjectId(item)) {
                    return `<span class="text-blue-600 underline cursor-pointer font-medium hover:text-blue-800 transition-colors" onclick="viewDocumentById('${item}', '${field}')" title="Click to view this document">"${item}"</span>`;
                  }
                  return JSON.stringify(item);
                });
                displayValue = `[${formattedArray.join(', ')}]`;
                fieldType = `array (${value.length} items, contains ObjectIds)`;
              } else {
                displayValue = `<pre class="bg-gray-50 p-3 rounded overflow-x-auto text-xs m-0"><code class="font-mono">${JSON.stringify(value, null, 2)}</code></pre>`;
                fieldType = `array (${value.length} items)`;
              }
            } else {
              const objectIdFields = Object.entries(value).filter(([k, v]) => typeof v === 'string' && isObjectId(v));
              if (objectIdFields.length > 0) {
                const formattedObj = JSON.parse(JSON.stringify(value));
                objectIdFields.forEach(([k, v]) => {
                  formattedObj[k] = `__OBJECTID_LINK_${v}__`;
                });
                let jsonStr = JSON.stringify(formattedObj, null, 2);
                objectIdFields.forEach(([k, v]) => {
                  const placeholder = `"__OBJECTID_LINK_${v}__"`;
                  const link = `<span class="text-blue-600 underline cursor-pointer font-medium hover:text-blue-800 transition-colors" onclick="viewDocumentById('${v}', '${k}')" title="Click to view this document">"${v}"</span>`;
                  jsonStr = jsonStr.replace(placeholder, link);
                });
                displayValue = `<pre class="bg-gray-50 p-3 rounded overflow-x-auto text-xs m-0"><code class="font-mono">${jsonStr}</code></pre>`;
                fieldType = 'object (contains ObjectIds)';
              } else {
                displayValue = `<pre class="bg-gray-50 p-3 rounded overflow-x-auto text-xs m-0"><code class="font-mono">${JSON.stringify(value, null, 2)}</code></pre>`;
                fieldType = 'object';
              }
            }
          } else if (typeof value === 'boolean') {
            // Boolean: green for true, red for false
            const colorClass = value ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const text = value ? 'True' : 'False';
            displayValue = `<span class="px-3 py-1.5 rounded text-sm font-semibold ${colorClass}">${text}</span>`;
            fieldType = 'boolean';
          } else if (isEnum) {
            // Enum: render as colored label/badge
            // Pass the original value to getEnumColor for consistent hashing
            const colorClass = getEnumColor(value);
            const enumValue = String(value);
            const enumDisplay = titleize(enumValue);
            displayValue = `<span class="px-3 py-1.5 rounded text-sm font-semibold ${colorClass}">${escapeHtml(enumDisplay)}</span>`;
            fieldType = schemaType || 'enum';
          } else if (typeof value === 'boolean') {
            // Boolean: green for true, red for false
            const colorClass = value ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const text = value ? 'True' : 'False';
            displayValue = `<span class="px-3 py-1.5 rounded text-sm font-semibold ${colorClass}">${text}</span>`;
            fieldType = schemaType || 'boolean';
          } else if (typeof value === 'number') {
            displayValue = `<strong>${value}</strong>`;
            if (schemaType) {
              fieldType = schemaType;
            } else {
              fieldType = Number.isInteger(value) ? 'integer' : 'number';
            }
          } else if (typeof value === 'string') {
            if (isObjectId(value)) {
              displayValue = `<span class="text-blue-600 underline cursor-pointer font-medium hover:text-blue-800 transition-colors" onclick="viewDocumentById('${value}', '${field}')" title="Click to view this document">${value}</span>`;
              fieldType = schemaType || 'ObjectId';
            } else {
              // Check if schema indicates date/datetime type
              if (schemaType && (schemaType === 'datetime' || schemaType === 'date' || schemaType === 'timestamp')) {
                try {
                  const date = new Date(value);
                  if (!isNaN(date.getTime())) {
                    displayValue = `${value}<br><small class="text-gray-500">${date.toLocaleString()}</small>`;
                    fieldType = schemaType;
                  } else {
                    displayValue = value;
                    fieldType = schemaType || 'string';
                  }
                } catch (e) {
                  displayValue = value;
                  fieldType = schemaType || 'string';
                }
              } else {
                const dateMatch = value.match(/^\d{4}-\d{2}-\d{2}/);
                if (dateMatch) {
                  try {
                    const date = new Date(value);
                    if (!isNaN(date.getTime())) {
                      displayValue = `${value}<br><small class="text-gray-500">${date.toLocaleString()}</small>`;
                      fieldType = 'datetime';
                    } else {
                      displayValue = value;
                      fieldType = schemaType || 'string';
                    }
                  } catch (e) {
                    displayValue = value;
                    fieldType = schemaType || 'string';
                  }
                } else {
                  displayValue = value;
                  fieldType = schemaType || 'string';
                }
              }
            }
          } else {
            displayValue = String(value);
            fieldType = schemaType || typeof value;
          }
          return `
                    <div class="p-4 border-b border-gray-200 last:border-b-0">
                        <div class="font-semibold text-gray-700 mb-2 text-sm uppercase tracking-wide">
                            ${field}
                            <span class="bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded text-xs ml-2 font-normal normal-case tracking-normal">${fieldType}</span>
                        </div>
                        <div class="text-gray-800 text-base break-words">${displayValue}</div>
                    </div>
                `;
        }).join('');
      }

      function closeViewModal() {
        document.getElementById('view-modal').classList.add('hidden');
        currentViewingDocumentId.value = null;
        viewHistory.value = [];
      }

      function goBackInView() {
        if (viewHistory.value.length > 0) {
          isNavigatingBack.value = true;
          const previous = viewHistory.value.pop();
          viewHistory.value = viewHistory.value;
          viewDocument(previous.id, previous.collection);
        }
      }

      function switchToEditFromView() {
        closeViewModal();
        if (currentViewingDocumentId.value) {
          editDocument(currentViewingDocumentId.value);
        }
      }

      async function editDocument(id) {
        try {
          document.getElementById('loading-view').classList.remove('hidden');
          // Load document and schema in parallel
          const [docResponse, schemaResponse] = await Promise.all([
            fetch(`${API_BASE}/collections/${currentCollection.value}/documents/${id}`),
            fetch(`${API_BASE}/collections/${currentCollection.value}/schema?sample_size=10`)
          ]);

          if (!docResponse.ok) {
            throw new Error(`Failed to load document: ${docResponse.statusText}`);
          }

          const doc = await docResponse.json();

          // Load schema if not already loaded or if it's empty
          if (schemaResponse.ok) {
            currentSchema.value = await schemaResponse.json();
          }

          document.getElementById('loading-view').classList.add('hidden');
          document.getElementById('modal-title').textContent = `Edit Document - ${currentCollection.value}`;
                document.getElementById('document-form').dataset.mode = 'edit';
                document.getElementById('document-form').dataset.id = id;
                renderForm(doc);
          document.getElementById('modal').classList.remove('hidden');
            } catch (error) {
          document.getElementById('loading-view').classList.add('hidden');
                showError('Failed to load document: ' + error.message);
            }
        }

        function renderForm(doc) {
            const formFields = document.getElementById('form-fields');
        if (currentSchema.value && currentSchema.value.fields && Object.keys(currentSchema.value.fields).length > 0) {
          const fields = Object.keys(currentSchema.value.fields);
          const fieldsPerPage = 5;

          // Reset to first page when rendering form
          formPage.value = 0;

          // Generate HTML for all fields
          const allFieldHTML = fields.map(field => {
            const fieldInfo = currentSchema.value.fields[field];
                    let value = doc[field] !== undefined ? doc[field] : '';
                    let input = '';
                    const fieldType = fieldInfo.type ? String(fieldInfo.type).toLowerCase() : '';
                    const fieldNameLower = field.toLowerCase();
                    // Determine if field is required (not nullable)
                    const isRequired = !fieldInfo.nullable;
                    const requiredAttr = isRequired ? 'required' : '';

                    // Preserve original value type for proper rendering
                    if (fieldType === 'bool' || fieldType === 'boolean') {
                        const checked = value === true || value === 'true' || String(value).toLowerCase() === 'true';
              input = `<input type="checkbox" id="field-${field}" ${checked ? 'checked' : ''} ${requiredAttr} class="w-4 h-4">`;
                    } else if (fieldType === 'int' || fieldType === 'integer') {
                        // Preserve integer value, handle null/undefined
                        const numValue = (value === null || value === undefined || value === '') ? '' : Number(value);
              input = `<input type="number" id="field-${field}" value="${numValue}" step="1" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800">`;
                    } else if (fieldType === 'decimal') {
                        // Decimal type: use number input with 2 decimal places
                        const numValue = (value === null || value === undefined || value === '') ? '' : Number(value);
              input = `<input type="number" id="field-${field}" value="${numValue}" step="0.01" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800">`;
                    } else if (fieldType === 'float' || fieldType === 'double') {
                        // Preserve float value, handle null/undefined
                        const numValue = (value === null || value === undefined || value === '') ? '' : Number(value);
              input = `<input type="number" id="field-${field}" value="${numValue}" step="0.01" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800">`;
                    } else if (fieldType === 'dict' || fieldType === 'object') {
                        // Preserve object structure
                        let jsonValue = '{}';
                        if (value !== null && value !== undefined && value !== '') {
                            if (typeof value === 'object' && !Array.isArray(value)) {
                                jsonValue = JSON.stringify(value, null, 2);
                            } else if (typeof value === 'string' && (value.startsWith('{') || value.startsWith('['))) {
                                // Try to parse if it's a JSON string
                                try {
                                    const parsed = JSON.parse(value);
                                    jsonValue = typeof parsed === 'object' && !Array.isArray(parsed) ? JSON.stringify(parsed, null, 2) : '{}';
                                } catch {
                                    jsonValue = '{}';
                                }
                            }
                        }
              input = `<textarea id="field-${field}" placeholder='{"key": "value"}' rows="6" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm font-mono min-h-24 bg-white text-gray-800">${escapeHtml(jsonValue)}</textarea>`;
                    } else if (fieldType === 'list' || fieldType === 'array') {
                        // Preserve array structure
                        let jsonValue = '[]';
                        if (value !== null && value !== undefined && value !== '') {
                            if (Array.isArray(value)) {
                                jsonValue = JSON.stringify(value, null, 2);
                            } else if (typeof value === 'string' && (value.startsWith('[') || value.startsWith('{'))) {
                                // Try to parse if it's a JSON string
                                try {
                                    const parsed = JSON.parse(value);
                                    jsonValue = Array.isArray(parsed) ? JSON.stringify(parsed, null, 2) : '[]';
                                } catch {
                                    jsonValue = '[]';
                                }
                            }
                        }
              input = `<textarea id="field-${field}" placeholder='["item1", "item2"]' rows="6" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm font-mono min-h-24 bg-white text-gray-800">${escapeHtml(jsonValue)}</textarea>`;
                    } else if (fieldInfo.enum && Array.isArray(fieldInfo.enum)) {
                        // Enum type: use dropdown/select (sorted)
                        const sortedEnum = [...fieldInfo.enum].sort((a, b) => {
                            const aStr = String(a);
                            const bStr = String(b);
                            return aStr.localeCompare(bStr, undefined, { sensitivity: 'base' });
                        });
                        const currentValue = value !== null && value !== undefined ? String(value) : '';
                        const options = sortedEnum.map(enumVal => {
                            const enumStr = String(enumVal);
                            const enumDisplay = titleize(enumStr);
                            const selected = enumStr === currentValue ? 'selected' : '';
                            return `<option value="${escapeHtml(enumStr)}" ${selected}>${escapeHtml(enumDisplay)}</option>`;
                        }).join('');
                        // Add empty option if nullable
                        const emptyOption = fieldInfo.nullable
                            ? '<option value="">-- Select --</option>'
                            : '';
                        input = `<select id="field-${field}" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800">${emptyOption}${options}</select>`;
                    } else if (fieldType === 'objectid' || fieldType === 'object_id' || fieldType === 'ObjectId') {
                        // Preserve ObjectId as string
                        const objIdValue = value !== null && value !== undefined ? String(value) : '';
              input = `<input type="text" id="field-${field}" value="${escapeHtml(objIdValue)}" pattern="^[0-9a-fA-F]{24}$" placeholder="ObjectId (24 hex characters)" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm font-mono bg-white text-gray-800">`;
                    } else if (fieldType === 'datetime' || fieldType === 'date' || fieldType === 'timestamp') {
                        // Date/datetime input: convert to datetime-local format
                        let dateValue = '';
                        if (value !== null && value !== undefined && value !== '') {
                            try {
                                const date = new Date(value);
                                if (!isNaN(date.getTime())) {
                                    // Format as YYYY-MM-DDTHH:mm for datetime-local input
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    const hours = String(date.getHours()).padStart(2, '0');
                                    const minutes = String(date.getMinutes()).padStart(2, '0');
                                    dateValue = `${year}-${month}-${day}T${hours}:${minutes}`;
                                }
                            } catch (e) {
                                // If parsing fails, leave empty
                            }
                        }
                        const inputType = fieldType === 'date' ? 'date' : 'datetime-local';
              input = `<input type="${inputType}" id="field-${field}" value="${escapeHtml(dateValue)}" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800">`;
                    } else if (fieldType === 'str' || fieldType === 'string') {
                        // Non-enum string field: add autocomplete
                        const strValue = value !== null && value !== undefined ? String(value) : '';
                        const datalistId = `datalist-${field}`;
                        if (fieldNameLower.includes('email') || (fieldInfo.example && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(fieldInfo.example)))) {
                input = `<input type="email" id="field-${field}" list="${datalistId}" value="${escapeHtml(strValue)}" placeholder="email@example.com" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800" oninput="handleAutocomplete('${field}', '${datalistId}')"><datalist id="${datalistId}"></datalist>`;
                        } else if (fieldNameLower.includes('url') || fieldNameLower.includes('link') || (fieldInfo.example && /^https?:\/\//.test(String(fieldInfo.example)))) {
                input = `<input type="url" id="field-${field}" list="${datalistId}" value="${escapeHtml(strValue)}" placeholder="https://example.com" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800" oninput="handleAutocomplete('${field}', '${datalistId}')"><datalist id="${datalistId}"></datalist>`;
                        } else if (fieldNameLower.includes('password') || fieldNameLower.includes('secret') || fieldNameLower.includes('token')) {
                input = `<input type="password" id="field-${field}" value="${escapeHtml(strValue)}" placeholder="Enter password" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800">`;
                        } else if (fieldNameLower.includes('date') && !fieldNameLower.includes('time') && !fieldNameLower.includes('datetime')) {
                            // Date input: convert to date format
                            let dateValue = '';
                            if (value !== null && value !== undefined && value !== '') {
                                try {
                                    const date = new Date(value);
                                    if (!isNaN(date.getTime())) {
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const day = String(date.getDate()).padStart(2, '0');
                                        dateValue = `${year}-${month}-${day}`;
                                    }
                                } catch (e) {}
                            }
                            input = `<input type="date" id="field-${field}" value="${escapeHtml(dateValue)}" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800">`;
                        } else if (fieldNameLower.includes('date') || fieldNameLower.includes('time') || fieldNameLower.includes('created') || fieldNameLower.includes('updated')) {
                            // Datetime input: convert to datetime-local format
                            let dateValue = '';
                            if (value !== null && value !== undefined && value !== '') {
                                try {
                                    const date = new Date(value);
                                    if (!isNaN(date.getTime())) {
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const day = String(date.getDate()).padStart(2, '0');
                                        const hours = String(date.getHours()).padStart(2, '0');
                                        const minutes = String(date.getMinutes()).padStart(2, '0');
                                        dateValue = `${year}-${month}-${day}T${hours}:${minutes}`;
                                    }
                                } catch (e) {}
                            }
                            input = `<input type="datetime-local" id="field-${field}" value="${escapeHtml(dateValue)}" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800">`;
                        } else if (strValue.length > 100 || fieldNameLower.includes('description') || fieldNameLower.includes('content') || fieldNameLower.includes('text') || fieldNameLower.includes('message')) {
                input = `<textarea id="field-${field}" rows="4" placeholder="Enter text" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800">${escapeHtml(strValue)}</textarea>`;
                        } else {
                input = `<input type="text" id="field-${field}" list="${datalistId}" value="${escapeHtml(strValue)}" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm bg-white text-gray-800" oninput="handleAutocomplete('${field}', '${datalistId}')"><datalist id="${datalistId}"></datalist>`;
                        }
                    } else {
                        // Fallback: preserve original type
                        let displayValue = '';
                        if (value === null || value === undefined) {
                            displayValue = '';
                        } else if (typeof value === 'object') {
                            displayValue = JSON.stringify(value, null, 2);
                        } else {
                            displayValue = String(value);
                        }
              input = `<textarea id="field-${field}" rows="4" placeholder="Enter value" ${requiredAttr} class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm font-mono bg-white text-gray-800">${escapeHtml(displayValue)}</textarea>`;
                    }
                    return {
                      field: field,
                      html: `
                        <div class="mb-5">
                            <label for="field-${field}" class="block mb-1 font-medium text-gray-700 text-sm">
                                ${field}
                                ${isRequired ? '<span class="text-red-500 ml-1">*</span>' : ''}
                                <span class="bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded text-xs ml-1">${fieldInfo.type}</span>
                                ${fieldInfo.nullable ? '<span class="bg-yellow-100 text-yellow-800 px-1.5 py-0.5 rounded text-xs ml-1">nullable</span>' : ''}
                            </label>
                            ${input}
                            ${fieldInfo.example !== undefined ? `<small class="text-gray-500 block mt-1 text-xs">Example: ${JSON.stringify(fieldInfo.example)}</small>` : ''}
                        </div>
                      `
                    };
                });

          // Split fields into pages of 5
          formFieldPages = [];
          for (let i = 0; i < allFieldHTML.length; i += fieldsPerPage) {
            formFieldPages.push(allFieldHTML.slice(i, i + fieldsPerPage));
          }

          // Render pagination UI
          renderFormPagination();
        } else {
          // Hide pagination for JSON editor mode
          const paginationEl = document.getElementById('form-pagination');
          if (paginationEl) {
            paginationEl.classList.add('hidden');
          }
                // Fallback: no schema or empty schema
                const fields = Object.keys(doc).filter(k => k !== '_id');
                if (fields.length === 0) {
                    // No schema and no document fields - provide JSON editor
                    const mode = document.getElementById('document-form').dataset.mode || 'create';
                    const isCreate = mode === 'create';
                    const initialJson = isCreate ? '{}' : JSON.stringify(doc, null, 2);
                    formFields.innerHTML = `
                        <div class="mb-5">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-yellow-800 mb-2">
                                    <strong>No schema detected for this collection.</strong>
                                </p>
                                <p class="text-sm text-yellow-700">
                                    ${isCreate
                                        ? 'The collection is empty. You can create a document by entering JSON data below. After creating the first document, the schema will be inferred automatically.'
                                        : 'You can edit the document using JSON format below.'}
                                </p>
                            </div>
                            <label for="json-editor" class="block mb-2 font-medium text-gray-700">
                                Document Data (JSON)
                            </label>
                            <textarea
                                id="json-editor"
                                rows="12"
                                placeholder='{"field1": "value1", "field2": 123, "field3": true}'
                                class="w-full px-3 py-2 border border-gray-300 rounded text-sm font-mono bg-white text-gray-800"
                                style="font-family: 'Courier New', monospace;">${escapeHtml(initialJson)}</textarea>
                            <small class="text-gray-500 block mt-1">
                                Enter valid JSON. Example: <code class="bg-gray-100 px-1 rounded">{"name": "John", "age": 30}</code>
                            </small>
                        </div>
                    `;
                    return;
                }
                formFields.innerHTML = fields.map(field => {
                    const originalValue = doc[field];
                    let input = '';
                    let displayValue = '';

                    if (originalValue === null || originalValue === undefined) {
                        displayValue = '';
                    } else if (typeof originalValue === 'boolean') {
                        input = `<input type="checkbox" id="field-${field}" ${originalValue ? 'checked' : ''} class="w-4 h-4">`;
                        return `
                            <div class="mb-5">
                                <label for="field-${field}" class="block mb-1 font-medium text-gray-700">${field}</label>
                                ${input}
                            </div>
                        `;
                    } else if (typeof originalValue === 'number') {
                        displayValue = originalValue;
                        input = `<input type="number" id="field-${field}" value="${displayValue}" step="${Number.isInteger(originalValue) ? '1' : '0.01'}" class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm">`;
                    } else if (Array.isArray(originalValue)) {
                        displayValue = JSON.stringify(originalValue, null, 2);
                        input = `<textarea id="field-${field}" rows="6" placeholder='["item1", "item2"]' class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm font-mono min-h-24">${escapeHtml(displayValue)}</textarea>`;
                    } else if (typeof originalValue === 'object') {
                        displayValue = JSON.stringify(originalValue, null, 2);
                        input = `<textarea id="field-${field}" rows="6" placeholder='{"key": "value"}' class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm font-mono min-h-24">${escapeHtml(displayValue)}</textarea>`;
                    } else {
                        displayValue = String(originalValue);
                        if (displayValue.length > 100) {
                            input = `<textarea id="field-${field}" rows="4" class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm">${escapeHtml(displayValue)}</textarea>`;
                        } else {
                            input = `<input type="text" id="field-${field}" value="${escapeHtml(displayValue)}" class="w-full px-2.5 py-2.5 border border-gray-300 rounded text-sm">`;
                        }
                    }
                    return `
                        <div class="mb-5">
                            <label for="field-${field}" class="block mb-1 font-medium text-gray-700">${field}</label>
                            ${input}
                        </div>
                    `;
                }).join('');

                // Enhance number inputs after rendering
                setTimeout(() => enhanceFormNumberInputs(), 0);
            }
        }

        function renderFormPagination() {
          const formFields = document.getElementById('form-fields');
          const paginationEl = document.getElementById('form-pagination');
          const prevBtn = document.getElementById('form-prev-btn');
          const nextBtn = document.getElementById('form-next-btn');
          const pageInfo = document.getElementById('form-page-info');

          if (!formFields || !paginationEl || formFieldPages.length === 0) {
            if (paginationEl) paginationEl.classList.add('hidden');
            return;
          }

          // Show pagination if more than 5 fields
          if (formFieldPages.length > 1) {
            paginationEl.classList.remove('hidden');
          } else {
            paginationEl.classList.add('hidden');
          }

          // Render all fields but hide/show based on current page
          const currentPage = formPage.value;
          formFields.innerHTML = formFieldPages.map((pageFields, pageIndex) => {
            const isVisible = pageIndex === currentPage;
            return pageFields.map(fieldObj => {
              // Add a wrapper div with page class to show/hide
              return `<div class="form-page-${pageIndex}" ${!isVisible ? 'style="display: none;"' : ''}>${fieldObj.html}</div>`;
            }).join('');
          }).join('');

          // Enhance number inputs with formatting and validation
          setTimeout(() => enhanceFormNumberInputs(), 0);

          // Update pagination controls
          if (prevBtn) {
            prevBtn.disabled = currentPage === 0;
          }
          if (nextBtn) {
            nextBtn.disabled = currentPage >= formFieldPages.length - 1;
          }
          if (pageInfo) {
            pageInfo.textContent = `Page ${currentPage + 1} of ${formFieldPages.length}`;
          }
        }

        function previousFormPage() {
          if (formPage.value > 0) {
            formPage.value = formPage.value - 1;
            updateFormPageVisibility();
          }
        }

        function nextFormPage() {
          if (formPage.value < formFieldPages.length - 1) {
            formPage.value = formPage.value + 1;
            updateFormPageVisibility();
          }
        }

        function updateFormPageVisibility() {
          const currentPage = formPage.value;
          const formFields = document.getElementById('form-fields');
          const paginationEl = document.getElementById('form-pagination');
          const prevBtn = document.getElementById('form-prev-btn');
          const nextBtn = document.getElementById('form-next-btn');
          const pageInfo = document.getElementById('form-page-info');

          if (!formFields) return;

          // Hide all pages
          formFields.querySelectorAll('[class^="form-page-"]').forEach(el => {
            el.style.display = 'none';
          });

          // Show current page
          const currentPageElements = formFields.querySelectorAll(`.form-page-${currentPage}`);
          currentPageElements.forEach(el => {
            el.style.display = '';
          });

          // Update pagination controls
          if (prevBtn) {
            prevBtn.disabled = currentPage === 0;
          }
          if (nextBtn) {
            nextBtn.disabled = currentPage >= formFieldPages.length - 1;
          }
          if (pageInfo) {
            pageInfo.textContent = `Page ${currentPage + 1} of ${formFieldPages.length}`;
          }
        }

        // Enhance number inputs with formatting and validation
        function enhanceFormNumberInputs() {
          if (typeof window.enhanceNumberInput === 'undefined') {
            return; // Utilities not loaded
          }

          const formFields = document.getElementById('form-fields');
          if (!formFields) return;

          // Find all number inputs
          const numberInputs = formFields.querySelectorAll('input[type="number"]');

          numberInputs.forEach(input => {
            // Skip if already enhanced
            if (input.dataset.enhanced === 'true') return;

            const fieldName = input.id.replace('field-', '');
            const fieldNameLower = fieldName.toLowerCase();

            // Determine if this is a price/currency field
            const isPrice = fieldNameLower.includes('price') ||
                           fieldNameLower.includes('cost') ||
                           fieldNameLower.includes('amount') ||
                           fieldNameLower.includes('fee') ||
                           fieldNameLower.includes('total') ||
                           fieldNameLower.includes('sum');

            // Get step value
            const step = parseFloat(input.getAttribute('step')) || 0.01;
            const min = input.hasAttribute('min') ? parseFloat(input.getAttribute('min')) : undefined;
            const max = input.hasAttribute('max') ? parseFloat(input.getAttribute('max')) : undefined;

            // Enhance the input
            window.enhanceNumberInput(input, {
              formatOnBlur: true,
              showCurrency: isPrice,
              currency: 'USD',
              min: min,
              max: max,
              step: step
            });

            // Mark as enhanced
            input.dataset.enhanced = 'true';
          });
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const form = document.getElementById('document-form');
            const mode = form.dataset.mode;
            const formFields = document.getElementById('form-fields');

            // Check if we're using JSON editor (no schema case)
            const jsonEditor = document.getElementById('json-editor');
            if (jsonEditor) {
                try {
                    const jsonText = jsonEditor.value.trim();
                    if (!jsonText) {
                        showError('Please enter JSON data');
                        return;
                    }
                    const data = JSON.parse(jsonText);
                    if (typeof data !== 'object' || Array.isArray(data)) {
                        showError('JSON must be an object (not an array)');
                        return;
                    }
                    // Remove _id if present (will be auto-generated for new documents)
                    if (mode === 'create') {
                        delete data._id;
                    }

                    // Submit the parsed JSON data
                    try {
                        document.getElementById('loading-view').classList.remove('hidden');
                        let response;
                        if (mode === 'create') {
                            response = await fetch(`${API_BASE}/collections/${currentCollection.value}/documents`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });
                        } else {
                            response = await fetch(`${API_BASE}/collections/${currentCollection.value}/documents/${form.dataset.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });
                        }
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Operation failed');
                        }
                        document.getElementById('loading-view').classList.add('hidden');
                        showSuccess(`Document ${mode === 'create' ? 'created' : 'updated'} successfully`);
                        closeModal();
                        if (currentViewingDocumentId.value && mode === 'edit') {
                            setTimeout(() => {
                                viewDocument(currentViewingDocumentId.value);
                            }, 500);
                        }
                        if (currentView.value === 'browse') {
                            loadDocuments();
                        } else {
                            navigateTo(currentCollection.value, 'browse');
                        }
                    } catch (error) {
                        document.getElementById('loading-view').classList.add('hidden');
                        showError('Failed to save document: ' + error.message);
                    }
                    return;
                } catch (error) {
                    showError('Invalid JSON: ' + error.message);
                    return;
                }
            }

            // Normal form processing (with schema)
            const inputs = formFields.querySelectorAll('[id^="field-"]');
            const data = {};
            inputs.forEach(input => {
                const fieldName = input.id.replace('field-', '');
                const fieldInfo = currentSchema.value && currentSchema.value.fields && currentSchema.value.fields[fieldName];
                const fieldType = fieldInfo ? fieldInfo.type.toLowerCase() : null;
                let value = input.value;

                // Handle based on input type first, then validate against schema
                if (input.type === 'checkbox') {
                    value = input.checked;
                } else if (input.type === 'number') {
                    if (value === '' || value === null) {
                        value = fieldInfo && fieldInfo.nullable ? null : undefined;
                    } else {
                        // Parse formatted number (handles currency symbols, commas, etc.)
                        let numValue;
                        if (typeof window.parseFormattedNumber !== 'undefined') {
                            numValue = window.parseFormattedNumber(value);
                        } else {
                            numValue = parseFloat(value);
                        }

                        if (isNaN(numValue)) {
                            showError(`Invalid number in field ${fieldName}`);
                            return;
                        }

                        // Preserve number type based on schema
                        if (fieldType === 'int' || fieldType === 'integer') {
                            value = parseInt(numValue, 10);
                        } else if (fieldType === 'decimal') {
                            // Decimal: parse as float and round to 2 decimal places
                            value = Math.round(numValue * 100) / 100;
                        } else if (fieldType === 'float' || fieldType === 'double') {
                            value = parseFloat(numValue);
                        } else {
                            // Fallback: use step to determine type
                            value = input.step && parseFloat(input.step) < 1 ? parseFloat(numValue) : parseInt(numValue, 10);
                        }
                    }
                } else if (input.type === 'date') {
                    value = value || null;
                    if (value) {
                        value = new Date(value + 'T00:00:00Z').toISOString();
                    }
                } else if (input.type === 'datetime-local') {
                    value = value || null;
                    if (value) {
                        const dateObj = new Date(value);
                        if (!isNaN(dateObj.getTime())) {
                            value = dateObj.toISOString();
                        } else {
                            value = null;
                        }
                    }
                } else if (input.tagName === 'TEXTAREA') {
                    const trimmed = value.trim();
                    if (trimmed === '') {
                        value = fieldInfo && fieldInfo.nullable ? null : undefined;
                    } else {
                        // Check schema type to determine how to parse
                        if (fieldType === 'dict' || fieldType === 'object') {
                            try {
                                value = JSON.parse(trimmed);
                                // Ensure it's an object, not an array
                                if (Array.isArray(value)) {
                                    throw new Error('Expected object, got array');
                                }
                            } catch (e) {
                                showError(`Invalid JSON object in field ${fieldName}: ${e.message}`);
                                return;
                            }
                        } else if (fieldType === 'list' || fieldType === 'array') {
                            try {
                                value = JSON.parse(trimmed);
                                // Ensure it's an array, not an object
                                if (!Array.isArray(value)) {
                                    throw new Error('Expected array, got object');
                                }
                            } catch (e) {
                                showError(`Invalid JSON array in field ${fieldName}: ${e.message}`);
                                return;
                            }
                    } else if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
                            // Try to parse as JSON if it looks like JSON (for cases without schema)
                        try {
                            value = JSON.parse(trimmed);
                        } catch (e) {
                            showError(`Invalid JSON in field ${fieldName}: ${e.message}`);
                            return;
                        }
                    } else {
                            // Keep as string if it doesn't look like JSON
                        value = trimmed;
                        }
                    }
                } else if (input.tagName === 'SELECT') {
                    // Handle select/dropdown (enum fields)
                    if (value === '' || value === null) {
                        value = fieldInfo && fieldInfo.nullable ? null : undefined;
                    } else {
                        // Convert to appropriate type based on enum values
                        // Check if enum values are numbers
                        if (fieldInfo && fieldInfo.enum && fieldInfo.enum.length > 0) {
                            const firstEnumVal = fieldInfo.enum[0];
                            if (typeof firstEnumVal === 'number' || !isNaN(Number(firstEnumVal))) {
                                // Try to convert to number if enum values are numeric
                                const numVal = Number(value);
                                if (!isNaN(numVal) && fieldInfo.enum.includes(numVal)) {
                                    value = numVal;
                                } else {
                                    value = String(value);
                                }
                            } else {
                                value = String(value);
                            }
                        } else {
                            value = String(value);
                        }
                    }
                } else if (input.type === 'email' || input.type === 'url' || input.type === 'text' || input.type === 'password') {
                    const trimmed = value.trim();
                    if (trimmed === '') {
                        value = fieldInfo && fieldInfo.nullable ? null : undefined;
                    } else {
                        // For ObjectId fields, validate format
                        if (fieldType === 'objectid') {
                            if (!/^[0-9a-fA-F]{24}$/.test(trimmed)) {
                                showError(`Invalid ObjectId format in field ${fieldName}. Must be 24 hex characters.`);
                                return;
                            }
                            value = trimmed;
                        } else {
                            value = trimmed;
                        }
                    }
                }

                // Only add to data if value is not undefined
                if (value !== undefined) {
                    if (value === null && fieldInfo && !fieldInfo.nullable) {
                        // Skip null values for non-nullable fields
                        return;
                    }
                    // Preserve the data type
                    data[fieldName] = value;
                }
            });
            try {
          document.getElementById('loading-view').classList.remove('hidden');
                let response;
                if (mode === 'create') {
            response = await fetch(`${API_BASE}/collections/${currentCollection.value}/documents`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
            });
                } else {
            response = await fetch(`${API_BASE}/collections/${currentCollection.value}/documents/${form.dataset.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
            });
                        }
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Operation failed');
                }
          document.getElementById('loading-view').classList.add('hidden');
                showSuccess(`Document ${mode === 'create' ? 'created' : 'updated'} successfully`);
                closeModal();
          if (currentViewingDocumentId.value && mode === 'edit') {
            setTimeout(() => {
              viewDocument(currentViewingDocumentId.value);
            }, 500);
          }
          if (currentView.value === 'browse') {
                    loadDocuments();
                } else {
            navigateTo(currentCollection.value, 'browse');
                }
            } catch (error) {
          document.getElementById('loading-view').classList.add('hidden');
                showError('Failed to save document: ' + error.message);
            }
        }

      function showDeleteConfirm(id, fromDetail = false) {
        pendingDeleteAction = () => performDelete(id, fromDetail);
        document.getElementById('confirm-modal-title').textContent = 'Confirm Delete';
        document.getElementById('confirm-modal-message').textContent = 'Are you sure you want to delete this document? This action cannot be undone.';
        document.getElementById('confirm-modal').classList.remove('hidden');
      }

      function closeConfirmModal() {
        document.getElementById('confirm-modal').classList.add('hidden');
        pendingDeleteAction = null;
      }

      function executeDelete() {
        if (pendingDeleteAction) {
          pendingDeleteAction();
          closeConfirmModal();
        }
      }

      async function performDelete(id, fromDetail = false) {
        try {
          document.getElementById('loading-view').classList.remove('hidden');
          const response = await fetch(`${API_BASE}/collections/${currentCollection.value}/documents/${id}`, { method: 'DELETE' });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Delete failed');
                }
          document.getElementById('loading-view').classList.add('hidden');
                showSuccess('Document deleted successfully');
          if (fromDetail) {
            goBackToList();
          } else {
                loadDocuments();
          }
            } catch (error) {
          document.getElementById('loading-view').classList.add('hidden');
                showError('Failed to delete document: ' + error.message);
            }
      }

      function deleteDocument(id) {
        showDeleteConfirm(id, false);
      }

      async function loadSchema() {
        try {
          const response = await fetch(`${API_BASE}/collections/${currentCollection.value}/schema?sample_size=10`);
          currentSchema.value = await response.json();
          document.getElementById('loading-view').classList.add('hidden');
          document.getElementById('schema-view').classList.remove('hidden');
          renderSchema(currentSchema.value);
        } catch (error) {
          document.getElementById('loading-view').classList.add('hidden');
          showError('Failed to load schema: ' + error.message);
        }
      }

      async function loadSchemaForCreate() {
        try {
          const response = await fetch(`${API_BASE}/collections/${currentCollection.value}/schema?sample_size=10`);
          currentSchema.value = await response.json();
          document.getElementById('loading-view').classList.add('hidden');
          showCreateModal();
        } catch (error) {
          document.getElementById('loading-view').classList.add('hidden');
          showError('Failed to load schema: ' + error.message);
          showCreateModal();
        }
      }

      function renderSchema(schema) {
        const container = document.getElementById('schema-container');
        if (!schema.fields || Object.keys(schema.fields).length === 0) {
          container.innerHTML = '<div class="text-center py-10 text-gray-400"><p>No schema detected. Collection may be empty.</p></div>';
          return;
        }
        container.innerHTML = `
                <div class="mb-5 pb-5 border-b-2 border-gray-200">
                    <h3 class="mb-2.5 text-xl font-semibold text-gray-800">Collection Schema</h3>
                    <p class="text-gray-500 text-sm">Analyzed ${schema.sample_count} sample document(s)</p>
                </div>
                ${Object.entries(schema.fields).map(([field, info]) => `
                    <div class="p-4 border-b border-gray-200 last:border-b-0">
                        <div class="font-semibold text-gray-800 mb-2 text-base">${field}</div>
                        <div class="flex gap-4 flex-wrap">
                            <div class="flex items-center gap-1">
                                <span class="text-gray-500 text-xs">Type:</span>
                                <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs font-medium">${info.type}</span>
                            </div>
                            ${info.types.length > 1 ? `
                                <div class="flex items-center gap-1">
                                    <span class="text-gray-500 text-xs">All Types:</span>
                                    <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs font-medium">${info.types.join(', ')}</span>
                                </div>
                            ` : ''}
                            ${info.nullable ? `
                                <div class="flex items-center">
                                    <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-medium">Nullable</span>
                                </div>
                            ` : ''}
                        </div>
                        ${info.example !== undefined ? `
                            <div class="mt-2.5 p-2.5 bg-gray-50 rounded text-xs font-mono text-gray-700">
                                <strong>Example:</strong> ${JSON.stringify(info.example, null, 2)}
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;
        }

      // Analytics chart instance
      let currentAnalyticsChart = null;

      async function loadAnalyticsView() {
        try {
          // Load schema to populate field dropdowns
          const response = await fetch(`${API_BASE}/collections/${currentCollection.value}/schema?sample_size=10`);
          currentSchema.value = await response.json();
          document.getElementById('loading-view').classList.add('hidden');
          document.getElementById('analytics-view').classList.remove('hidden');
          populateAnalyticsFields(currentSchema.value);
          // Show empty state initially
          document.getElementById('analytics-empty-state').classList.remove('hidden');
          document.getElementById('analytics-chart-container').classList.add('hidden');
        } catch (error) {
          document.getElementById('loading-view').classList.add('hidden');
          showError('Failed to load analytics view: ' + error.message);
        }
      }

      function populateAnalyticsFields(schema) {
        const fieldSelect = document.getElementById('analytics-field-select');
        const groupBySelect = document.getElementById('analytics-group-by-select');

        // Clear existing options (except first option)
        fieldSelect.innerHTML = '<option value="">Select a field...</option>';
        groupBySelect.innerHTML = '<option value="">None</option>';

        if (!schema.fields || Object.keys(schema.fields).length === 0) {
          // Show helpful message when no schema is available
          const analyticsConfig = document.querySelector('#analytics-view > div:first-child');
          if (analyticsConfig) {
            const existingMessage = analyticsConfig.querySelector('.no-schema-message');
            if (!existingMessage) {
              const messageDiv = document.createElement('div');
              messageDiv.className = 'no-schema-message bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4';
              messageDiv.innerHTML = `
                <p class="text-sm text-yellow-800 mb-2">
                  <strong>No schema detected for this collection.</strong>
                </p>
                <p class="text-sm text-yellow-700">
                  The collection is empty or has no defined schema. Create some documents first, and the schema will be inferred automatically.
                  Once documents exist, you'll be able to select fields for analytics.
                </p>
              `;
              analyticsConfig.insertBefore(messageDiv, analyticsConfig.firstChild.nextSibling);
            }
          }
          return;
        }

        // Remove the no-schema message if it exists
        const analyticsConfig = document.querySelector('#analytics-view > div:first-child');
        if (analyticsConfig) {
          const existingMessage = analyticsConfig.querySelector('.no-schema-message');
          if (existingMessage) {
            existingMessage.remove();
          }
        }

        // Populate both selects with available fields (sorted)
        const fieldNames = Object.keys(schema.fields).sort((a, b) => {
          return a.localeCompare(b, undefined, { sensitivity: 'base' });
        });

        fieldNames.forEach(fieldName => {
          const fieldInfo = schema.fields[fieldName];
          const fieldType = fieldInfo.type.toLowerCase();

          // Only include numeric and categorical fields for analytics
          const isNumeric = ['int', 'float', 'decimal', 'number'].includes(fieldType);
          const isCategorical = ['str', 'string', 'bool', 'boolean'].includes(fieldType);

          if (isNumeric || isCategorical) {
            const option = document.createElement('option');
            option.value = fieldName;
            option.textContent = `${fieldName} (${fieldType})`;
            fieldSelect.appendChild(option);

            // Add to group by select as well
            const groupByOption = document.createElement('option');
            groupByOption.value = fieldName;
            groupByOption.textContent = `${fieldName} (${fieldType})`;
            groupBySelect.appendChild(groupByOption);
          }
        });
      }

      async function loadAnalytics() {
        const fieldSelect = document.getElementById('analytics-field-select');
        const selectedField = fieldSelect.value;

        if (!selectedField) {
          showError('Please select a field to plot');
          return;
        }

        if (!currentCollection.value) {
          showError('No collection selected');
          return;
        }

        try {
          const groupBy = document.getElementById('analytics-group-by-select').value || null;
          const aggregationType = document.getElementById('analytics-aggregation-select').value;

          // Build URL with query parameters
          let url = `${API_BASE}/collections/${currentCollection.value}/analytics?field=${encodeURIComponent(selectedField)}&aggregation_type=${aggregationType}&limit=100`;
          if (groupBy) {
            url += `&group_by=${encodeURIComponent(groupBy)}`;
          }

          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Failed to fetch analytics: ${response.statusText}`);
          }

          const data = await response.json();

          if (!data.data || data.data.length === 0) {
            document.getElementById('analytics-empty-state').classList.remove('hidden');
            document.getElementById('analytics-chart-container').classList.add('hidden');
            showError('No data available for the selected field');
            return;
          }

          // Hide empty state and show chart
          document.getElementById('analytics-empty-state').classList.add('hidden');
          document.getElementById('analytics-chart-container').classList.remove('hidden');

          // Update chart title
          const chartTitle = document.getElementById('analytics-chart-title');
          const titleText = groupBy
            ? `${selectedField} by ${groupBy} (${aggregationType})`
            : `${selectedField} (${aggregationType})`;
          chartTitle.textContent = titleText;

          // Render chart
          renderAnalyticsChart(data);
        } catch (error) {
          showError('Failed to load analytics: ' + error.message);
          document.getElementById('analytics-empty-state').classList.remove('hidden');
          document.getElementById('analytics-chart-container').classList.add('hidden');
        }
      }

      function renderAnalyticsChart(analyticsData) {
        const canvas = document.getElementById('analytics-chart');
        const ctx = canvas.getContext('2d');

        // Destroy existing chart if it exists
        if (currentAnalyticsChart) {
          currentAnalyticsChart.destroy();
          currentAnalyticsChart = null;
        }

        const chartType = document.getElementById('analytics-chart-type-select').value;
        const isGrouped = analyticsData.group_by !== null;

        // Prepare data based on chart type and grouping
        let labels = [];
        let datasets = [];

        // For both grouped and non-grouped data, the format is the same:
        // labels are the group_by values (or field values), data is the aggregated values
        labels = analyticsData.data.map(item => item.label);
        const data = analyticsData.data.map(item => {
          const value = item.data;
          return typeof value === 'number' ? value : parseFloat(value) || 0;
        });

        // Generate colors for pie/doughnut charts
        const colors = labels.map((_, i) => {
          const hue = (i * 137.5) % 360;
          return {
            backgroundColor: `hsla(${hue}, 70%, 60%, 0.8)`,
            borderColor: `hsl(${hue}, 70%, 50%)`,
          };
        });

        // Create dataset (same format for both grouped and non-grouped)
        const datasetLabel = isGrouped
          ? `${analyticsData.aggregation_type} of ${analyticsData.field} by ${analyticsData.group_by}`
          : `${analyticsData.field} (${analyticsData.aggregation_type})`;

        datasets = [{
          label: datasetLabel,
          data: data,
          backgroundColor: chartType === 'pie' || chartType === 'doughnut'
            ? colors.map(c => c.backgroundColor)
            : `hsla(220, 70%, 60%, 0.8)`,
          borderColor: chartType === 'pie' || chartType === 'doughnut'
            ? colors.map(c => c.borderColor)
            : `hsl(220, 70%, 50%)`,
          borderWidth: 2
        }];

        // Chart configuration
        const config = {
          type: chartType,
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
              },
              title: {
                display: true,
                text: analyticsData.group_by
                  ? `${analyticsData.field} by ${analyticsData.group_by}`
                  : analyticsData.field
              }
            },
            scales: chartType === 'pie' || chartType === 'doughnut' ? {} : {
              y: {
                beginAtZero: true
              }
            }
          }
        };

        // Create new chart
        currentAnalyticsChart = new Chart(ctx, config);
      }

        function closeModal() {
        document.getElementById('modal').classList.add('hidden');
        }

        function showError(message) {
            const el = document.getElementById('error-message');
            el.textContent = message;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            const el = document.getElementById('success-message');
            el.textContent = message;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 5000);
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        // Ensure dark mode is initialized (function is in darkmode.js)
        if (window.updateDarkMode) {
          window.updateDarkMode();
        }
        loadCollections();
        // Initialize sidebar state from localStorage
        const sidenav = document.getElementById('sidenav');
        const toggleBtn = document.querySelector('.sidebar-toggle-btn');
        if (sidebarCollapsed.value) {
          if (sidenav) sidenav.classList.add('collapsed');
          if (toggleBtn) {
            toggleBtn.classList.remove('hidden');
            toggleBtn.style.display = 'flex';
            toggleBtn.style.visibility = 'visible';
          }
        } else {
          if (sidenav) sidenav.classList.remove('collapsed');
          if (toggleBtn) {
            toggleBtn.classList.add('hidden');
            toggleBtn.style.display = 'none';
          }
        }
      });

      // Make functions globally available
      window.toggleSidebar = toggleSidebar;
      window.toggleCollection = toggleCollection;
      window.navigateTo = navigateTo;
      window.viewDocument = viewDocument;
      window.viewDocumentById = viewDocumentById;
      window.editDocument = editDocument;
        window.deleteDocument = deleteDocument;
        window.deleteDocumentFromDetail = deleteDocumentFromDetail;
        window.showDeleteConfirm = showDeleteConfirm;
        window.closeConfirmModal = closeConfirmModal;
        window.executeDelete = executeDelete;
        window.showCreateModal = showCreateModal;
      window.showDetailPage = showDetailPage;
      window.goBackToList = goBackToList;
      window.closeModal = closeModal;
      window.closeViewModal = closeViewModal;
      window.goBackInView = goBackInView;
      window.switchToEditFromView = switchToEditFromView;
      window.loadAnalytics = loadAnalytics;
      window.refreshDocuments = refreshDocuments;
      window.performSearch = performSearch;
      window.clearSearch = clearSearch;
      window.handleSearchKeyPress = handleSearchKeyPress;
      window.changePage = changePage;
      window.handleSubmit = handleSubmit;
      window.toggleFilters = toggleFilters;
      window.applyFilters = applyFilters;
      window.clearFilters = clearFilters;
      window.handleSort = handleSort;
      window.previousFormPage = previousFormPage;
      window.nextFormPage = nextFormPage;

      // Message Modal functions
      function showMessageModal(title, message, type = 'info') {
        const modal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('message-modal-title');
        const modalMessage = document.getElementById('message-modal-message');
        const modalIcon = document.getElementById('message-modal-icon');

        modalTitle.textContent = title;
        modalMessage.textContent = message;

        // Set icon and colors based on type
        if (type === 'error') {
          modalIcon.textContent = '‚ùå';
          modalIcon.className = 'text-4xl mb-4 text-center text-red-600';
        } else if (type === 'success') {
          modalIcon.textContent = '‚úÖ';
          modalIcon.className = 'text-4xl mb-4 text-center text-green-600';
        } else if (type === 'warning') {
          modalIcon.textContent = '‚ö†Ô∏è';
          modalIcon.className = 'text-4xl mb-4 text-center text-yellow-600';
        } else {
          modalIcon.textContent = '‚ÑπÔ∏è';
          modalIcon.className = 'text-4xl mb-4 text-center text-blue-600';
        }

        modal.classList.remove('hidden');
      }

      function closeMessageModal() {
        const modal = document.getElementById('message-modal');
        modal.classList.add('hidden');
      }

      // Import Confirmation Modal functions
      let pendingImportFile = null;
      let pendingImportFormat = 'json';

      function showImportConfirmModal(file, format) {
        pendingImportFile = file;
        pendingImportFormat = format;
        const modal = document.getElementById('import-confirm-modal');
        modal.classList.remove('hidden');
      }

      function closeImportConfirmModal(overwrite) {
        const modal = document.getElementById('import-confirm-modal');
        modal.classList.add('hidden');

        if (overwrite === true || overwrite === false) {
          // User made a choice (Yes or No), proceed with import
          if (pendingImportFile) {
            proceedWithImport(pendingImportFile, pendingImportFormat, overwrite);
          }
        } else {
          // User clicked outside or cancelled, reset file input
          const fileInput = document.getElementById('import-file');
          if (fileInput) fileInput.value = '';
        }

        pendingImportFile = null;
        pendingImportFormat = 'json';
      }

      async function proceedWithImport(file, format, overwrite) {
        const collection = currentCollection.value;
        const formData = new FormData();
        formData.append('file', file);

        try {
          const response = await fetch(
            `${API_BASE}/collections/${collection}/import?format=${format}&overwrite=${overwrite}`,
            {
              method: 'POST',
              body: formData,
            }
          );

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Import failed');
          }

          const result = await response.json();
          showMessageModal(
            'Import Completed',
            `Import completed successfully!\n\nInserted: ${result.inserted}\nUpdated: ${result.updated}\nTotal: ${result.total}`,
            'success'
          );

          // Refresh documents
          await loadDocuments();
        } catch (error) {
          console.error('Import error:', error);
          showMessageModal('Import Failed', 'Failed to import file: ' + error.message, 'error');
        } finally {
          // Reset file input
          const fileInput = document.getElementById('import-file');
          if (fileInput) fileInput.value = '';
        }
      }

      // Export/Import functions
      function toggleExportMenu() {
        const menu = document.getElementById('export-menu');
        menu.classList.toggle('hidden');
      }

      // Close export menu when clicking outside
      document.addEventListener('click', function(event) {
        const exportBtn = document.getElementById('export-btn');
        const exportMenu = document.getElementById('export-menu');
        if (exportBtn && exportMenu && !exportBtn.contains(event.target) && !exportMenu.contains(event.target)) {
          exportMenu.classList.add('hidden');
        }
      });

      async function exportCollection(format) {
        try {
          const collection = currentCollection.value;
          if (!collection) {
            showMessageModal('No Collection Selected', 'Please select a collection first', 'warning');
            return;
          }

          // Build query parameter if there's an active search
          let url = `${API_BASE}/collections/${collection}/export?format=${format}`;
          if (currentSearchQuery.value) {
            url += `&query=${encodeURIComponent(currentSearchQuery.value)}`;
          }

          // Trigger download
          const link = document.createElement('a');
          link.href = url;
          link.download = `${collection}.${format}`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // Close menu
          document.getElementById('export-menu').classList.add('hidden');
        } catch (error) {
          console.error('Export error:', error);
          showMessageModal('Export Failed', 'Failed to export collection: ' + error.message, 'error');
        }
      }

      async function handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();
        let format = 'json';

        if (fileName.endsWith('.yaml') || fileName.endsWith('.yml')) {
          format = 'yaml';
        } else if (fileName.endsWith('.csv')) {
          format = 'csv';
        } else if (fileName.endsWith('.toml')) {
          format = 'toml';
        }

        const collection = currentCollection.value;
        if (!collection) {
          showMessageModal('No Collection Selected', 'Please select a collection first', 'warning');
          event.target.value = '';
          return;
        }

        // Show confirmation modal
        showImportConfirmModal(file, format);
      }

      window.toggleExportMenu = toggleExportMenu;
      window.exportCollection = exportCollection;
      window.handleImportFile = handleImportFile;
      window.showMessageModal = showMessageModal;
      window.closeMessageModal = closeMessageModal;
      window.showImportConfirmModal = showImportConfirmModal;
      window.closeImportConfirmModal = closeImportConfirmModal;

      // Field Selection functions
      async function showFieldSelectionModal() {
        const collection = currentCollection.value;
        if (!collection) {
          showMessageModal('No Collection Selected', 'Please select a collection first', 'warning');
          return;
        }

        try {
          // Get fields from schema first, then supplement with actual document fields
          const schemaResponse = await fetch(`${API_BASE}/collections/${collection}/schema?sample_size=10`);
          const schema = await schemaResponse.json();

          // Also get a sample document to catch any fields not in schema
          const docResponse = await fetch(`${API_BASE}/collections/${collection}/documents?limit=10`);
          const docData = await docResponse.json();

          // Combine fields from schema and documents
          const schemaFields = schema.fields ? Object.keys(schema.fields) : [];
          const docFields = new Set();
          if (docData.documents && docData.documents.length > 0) {
            docData.documents.forEach(doc => {
              Object.keys(doc).forEach(key => docFields.add(key));
            });
          }

          // Merge and sort all fields
          const allFieldsSet = new Set([...schemaFields, ...Array.from(docFields)]);
          const allFields = Array.from(allFieldsSet).sort((a, b) => {
            if (a === '_id') return -1;
            if (b === '_id') return 1;
            return a.localeCompare(b);
          });

          if (allFields.length === 0) {
            showMessageModal('No Data', 'No fields found. Please ensure the collection has documents.', 'info');
            return;
          }

          // Get stored selection or default to all fields
          const storedFields = loadSelectedFields(collection);
          const currentSelection = storedFields || {};

          // If no stored selection, select all by default
          if (!storedFields || Object.keys(storedFields).length === 0) {
            allFields.forEach(field => {
              currentSelection[field] = true;
            });
          } else {
            // Ensure all current fields are in the selection (default to true for new fields)
            allFields.forEach(field => {
              if (currentSelection[field] === undefined) {
                currentSelection[field] = true;
              }
            });
          }

          // Populate modal
          const container = document.getElementById('field-selection-container');
          container.innerHTML = allFields.map(field => {
            const isChecked = currentSelection[field] !== false; // Default to true
            const isId = field === '_id';
            return `
              <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer ${isId ? 'opacity-75' : ''}">
                <input type="checkbox"
                       data-field="${escapeHtml(field)}"
                       ${isChecked ? 'checked' : ''}
                       ${isId ? 'disabled' : ''}
                       class="mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <span class="text-sm text-gray-700">${escapeHtml(titleize(field))} ${isId ? '<span class="text-gray-400 text-xs">(always visible)</span>' : ''}</span>
              </label>
            `;
          }).join('');

          // Show modal
          document.getElementById('field-selection-modal').classList.remove('hidden');
        } catch (error) {
          console.error('Error loading fields:', error);
          showMessageModal('Error', 'Failed to load available fields: ' + error.message, 'error');
        }
      }

      function closeFieldSelectionModal() {
        document.getElementById('field-selection-modal').classList.add('hidden');
      }

      function selectAllFields() {
        const checkboxes = document.querySelectorAll('#field-selection-container input[type="checkbox"]:not(:disabled)');
        checkboxes.forEach(cb => cb.checked = true);
      }

      function deselectAllFields() {
        const checkboxes = document.querySelectorAll('#field-selection-container input[type="checkbox"]:not(:disabled)');
        checkboxes.forEach(cb => cb.checked = false);
      }

      function applyFieldSelection() {
        const collection = currentCollection.value;
        if (!collection) {
          closeFieldSelectionModal();
          return;
        }

        const checkboxes = document.querySelectorAll('#field-selection-container input[type="checkbox"]');
        const selected = {};

        checkboxes.forEach(cb => {
          const field = cb.getAttribute('data-field');
          if (field) {
            selected[field] = cb.checked;
          }
        });

        // Always include _id
        selected['_id'] = true;

        // Save to localStorage
        saveSelectedFields(collection, selected);
        selectedFields.value = selected;

        // Close modal and refresh table
        closeFieldSelectionModal();

        // Reload documents to apply field filter
        loadDocuments();
      }

      window.showFieldSelectionModal = showFieldSelectionModal;
      window.closeFieldSelectionModal = closeFieldSelectionModal;
      window.selectAllFields = selectAllFields;
      window.deselectAllFields = deselectAllFields;
      window.applyFieldSelection = applyFieldSelection;
    </script>
</body>

</html>